<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<!--This is an "exploded" version of test_build.html intended for development use.
It loads all the dependencies explicitly so you don't have to go through the
build process to see changes. The downside is that you can't serve it off
the filesystem (no file://). The build process embeds the Scheme libraries
as JavaScript string literals. Without this, we ajax them in, but browsers do
not allow ajax on the filesystem.

   todo bl: perhaps we could embed them via a non-standard <script>?
   -->
<html>
<head>
    <title>Gay Lisp</title>
    <script type="text/javascript" src="../js/globals.js"></script>
    <script type="text/javascript" src="../js/timer.js"></script>
    <script type="text/javascript" src="../js/rename_helper.js"></script>
    <script type="text/javascript" src="../js/root_environment.js"></script>
    <script type="text/javascript" src="../js/port.js"></script>
    <script type="text/javascript" src="../js/callback_backed_port.js"></script>
    <script type="text/javascript" src="../js/node_backed_port.js"></script>
    <script type="text/javascript" src="../js/datum.js"></script>
    <script type="text/javascript" src="../js/environment.js"></script>
    <script type="text/javascript" src="../js/proc.js"></script>
    <script type="text/javascript" src="../js/errors.js"></script>
    <script type="text/javascript" src="../js/scanner.js"></script>
    <script type="text/javascript" src="../js/parse.js"></script>
    <script type="text/javascript" src="../js/output_modes.js"></script>
    <script type="text/javascript" src="../js/read.js"></script>
    <script type="text/javascript" src="../js/scheme_macro.js"></script>
    <script type="text/javascript" src="../js/transformer.js"></script>
    <script type="text/javascript" src="../js/list_like_transformer.js"></script>
    <script type="text/javascript" src="../js/ellipsis_transformer.js"></script>
    <script type="text/javascript" src="../js/id_or_literal_transformer.js"></script>
    <script type="text/javascript" src="../js/template_bindings.js"></script>
    <script type="text/javascript" src="../js/continuation.js"></script>
    <script type="text/javascript" src="../js/continuable.js"></script>
    <script type="text/javascript" src="../js/continuable_helper.js"></script>
    <script type="text/javascript" src="../js/branch.js"></script>
    <script type="text/javascript" src="../js/env_buffer.js"></script>
    <script type="text/javascript" src="../js/proc_call.js"></script>
    <script type="text/javascript" src="../js/js_obj_or_method.js"></script>
    <script type="text/javascript" src="../js/ffi.js"></script>
    <script type="text/javascript" src="../js/sibling_buffer.js"></script>
    <script type="text/javascript" src="../js/trampoline_helper.js"></script>
    <script type="text/javascript" src="../js/trampoline.js"></script>
    <script type="text/javascript" src="../js/cdr_helper.js"></script>
    <script type="text/javascript" src="../js/stdproc.js"></script>
    <script type="text/javascript" src="../js/unit_test.js"></script>
    <script type="text/javascript" src="../js/pipeline.js"></script>
    <script type="text/javascript" src="../js/boot.js"></script>
    <script type="text/javascript" src="../js/lazy_boot.js"></script>
    <script type="text/javascript">
        /* Set up the syntax and procedures vars so that the bootstrap call
         in api.js works. */

        /* This synchronous ajax stuff is just for development.
         In production, the Scheme syntax and procedure libraries are embedded
         as string literals into the big JavaScript file. */
        function ajaxSync(url, callback) {
            var req = new XMLHttpRequest();
            req.open('GET', url, false /* synchronous */);
            req.onreadystatechange = function () {
                if (req.readyState === 4 && req.status === 200)
                    callback(req.responseText);
            };
            req.send();
        }

        var syntax, procedures;

        ajaxSync('../scm/r5rs-syntax.scm', function (syntaxLib) {
            ajaxSync('../scm/r5rs-procedures.scm', function (procLib) {
                syntax = syntaxLib;
                procedures = procLib;
            });
        });
    </script>
    <script type="text/javascript" src="../api/api.js"></script>
    <script type="text/javascript">
        function doScan() {
            if (!window.console)
                alert('The console is used to display tokens, but your JavaScript environment doesn\'t have a console.');
            console.log(
                    GayLisp.tokenize(
                            document.getElementById('toEval').value));
        }

        function doRead() {
            var ans = GayLisp.read(document.getElementById('toEval').value);
            window.console && console.log(ans);
            document.getElementById('result').value = ans;
        }

        function doParse() {
            if (!window.console)
                alert('The console is used to display parse trees, but your JavaScript environment doesn\'t have a console.');
            console.log(
                    GayLisp.parse(
                            document.getElementById('toEval').value,
                            document.getElementById('lhs').value));
        }

        function doEval() {
            var ans = GayLisp.Eval(document.getElementById('toEval').value, function(sideEffect) {
                window.console && console.log(sideEffect);
            });
            window.console && console.log(ans);
            document.getElementById('result').value = ans;
        }

        function doUnitTests() {
            if (!window.console)
                alert('The unit tests use the console for display, but your JavaScript environment doesn\'t have a console.');
            ajaxSync('../../test/framework/unit-test.scm', function (testFramework) {
                ajaxSync('../../test/framework/unit-test-negative.scm', function (negativeTestFramework) {
                    ajaxSync('../../test/r5rs-tests.scm', function (r5rsTests) {
                        ajaxSync('../../test/other-tests.scm', function (otherTests) {
                            ajaxSync('../../test/negative-tests.scm', function (negativeTests) {
                                GayLisp.Eval(testFramework + r5rsTests + otherTests, function(sideEffect) {
                                    console.log(sideEffect);
                                });
                                GayLisp.Eval(negativeTestFramework + negativeTests, function(sideEffect) {
                                    console.log(sideEffect);
                                });
                            });
                        })
                    })
                });
            });
        }
    </script>

</head>
<body>
<textarea id='toEval' rows="15" cols="80"></textarea>
<textarea id='result' rows="1" cols="80"></textarea>
<p>
    <button onclick="doScan()">scan</button>
    <button onclick='doRead()'>read</button>
    <button onclick='doParse()'>parse</button>
    <button onclick='doEval()'>eval</button>
</p>
<p>
    <label>as:</label><textarea id='lhs' rows="1" cols="20"></textarea>
</p>
<p>
    <button onclick="GayLisp.test(null, function(se) { window.console && console.log(se); })">parser/scanner unit tests</button>
    <button onclick="doUnitTests()">evaluator unit tests</button>
</p>
</body>

</html>
