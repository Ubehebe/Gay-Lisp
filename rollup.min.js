var __extends=this&&this.__extends||function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(e,n)};return function(e,n){function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),__generator=this&&this.__generator||function(t,e){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function u(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=(i=s.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=e.call(t,s)}catch(t){o=[6,t],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}};!function(){"use strict";var t=function(){function t(){}return t.prototype.isCharReady=function(){return!1},t.prototype.peekChar=function(){return null},t.prototype.read=function(){return null},t.prototype.readChar=function(){return null},t.prototype.close=function(){},t}(),e=new t,n=function(){function t(){}return t.prototype.write=function(t){},t.prototype.close=function(){},t}(),r=new n,i=function(){function t(t){this.name=t}return t.prototype.toString=function(){return this.name},t}(),o=new i("alternate"),s=new i("assignment"),a=new i("command"),u=new i("command-or-definition"),c=new i("conditional"),l=new i("consequent"),f=new i("datum"),h=new i("datums"),p=new i("definition"),d=new i("expression"),g=new i("formals"),m=new i("keyword"),y=new i("lambda-expression"),v=new i("list-qq-template"),b=new i("literal"),w=new i("macro-block"),x=new i("macro-use"),N=new i("operand"),S=new i("operator"),C=new i("pattern"),P=new i("pattern-datum"),_=new i("pattern-identifier"),L=new i("procedure-call"),R=new i("program"),A=new i("quasiquotation"),E=new i("quotation"),k=new i("qq-template"),I=new i("qq-template-or-splice"),O=new i("self-evaluating"),q=new i("splicing-unquotation"),T=new i("syntax-definition"),F=new i("syntax-rule"),M=new i("syntax-spec"),B=new i("template"),D=new i("template-datum"),U=new i("test"),z=new i("transformer-spec"),V=new i("unquotation"),H=new i("variable"),G=new i("vector-qq-template"),Q="begin",j="define",Y="define-syntax",W=".",K="if",X="lambda",$="let-syntax",J="letrec-syntax",Z="(",tt=".(",et="#(",nt="quasiquote",rt="quote",it=")",ot="set!",st="'",at="unquote",ut="unquote-splicing",ct="@",lt=0;function ft(){return ct+lt++}function ht(t){switch(t){case Q:case j:case Y:case K:case X:case $:case J:case nt:case rt:case ot:case at:case ut:return!0;default:return!1}}var pt,dt=function(){function t(t){void 0===t&&(t="@"+gt++),this.resultName=t,this.next=null,this.env=null}return t.prototype.getResultName=function(){return this.resultName},t.prototype.setResultName=function(t){this.resultName=t},t.prototype.setStartingEnv=function(t){this.env=t},t.prototype.getEnv=function(){return this.env},t.prototype.clearEnv=function(){this.env=null},t.prototype.getNext=function(){return this.next},t.prototype.setNext=function(t){this.next=t},t.prototype.bindResult=function(t){var e=this.next&&this.next.getEnv()||this.env;e&&e.addBinding(this.resultName,t)},t.prototype.getLast=function(){var t=this.getNext();return t?t.getLast():this},t.prototype.append=function(t){this.getLast().setNext(t)},t}(),gt=0,mt=function(){function t(){this.nextSibling=null,this.parent=null,this.nonterminals=[],this.desugars=[],this.nextDesugar=-1,this.immutable=!1}return t.prototype.setImmutable=function(){return this.immutable=!0,this},t.prototype.getParent=function(){return this.parent},t.prototype.setParent=function(t){this.parent=t},t.prototype.getNextSibling=function(){return this.nextSibling},t.prototype.setNextSibling=function(t){this.nextSibling=t},t.prototype.isImmutable=function(){return this.immutable},t.prototype.clone=function(t){var e=new this.constructor;return this.parent&&(e.parent=this.parent),!this.nextSibling&&t&&(e.parent=t),this.immutable&&(e.immutable=!0),e},t.prototype.setParse=function(t){this.nonterminals.push(t)},t.prototype.setDesugar=function(t){this.desugars.push(t),++this.nextDesugar},t.prototype.peekParse=function(){var t=this.nonterminals.length;return t>0?this.nonterminals[t-1]:null},t.prototype.hasParse=function(t){if(this.nonterminals)for(var e=0,n=this.nonterminals;e<n.length;e++)if(n[e]===t)return!0;return!1},t.prototype.isImproperList=function(){return!1},t.prototype.resetDesugars=function(){-1===this.nextDesugar&&(this.nextDesugar+=this.desugars.length)},t.prototype.desugar=function(e,n){void 0===n&&(n=!1);var r=this.nextDesugar>=0?this.desugars[this.nextDesugar--]:null,i=r?r(this,e):this;return n&&i instanceof t&&(i=i.toProcCallLike()),i},t.prototype.sequence=function(e){for(var n,r,i,o=this;o;o=o.nextSibling)if(r=o.desugar(e)){var s=r instanceof t?r.toProcCallLike():r;n?i&&i.setNext(s):n=s,i=s.getLast()}return n},t.prototype.eqv=function(t){return this===t},t.prototype.lastSibling=function(){return this.nextSibling?this.nextSibling.lastSibling():this},t.prototype.fixParserSensitiveIds=function(t){this.nextSibling&&this.nextSibling.fixParserSensitiveIds(t)},t.prototype.toProcCallLike=function(){return new yt(this)},t}(),yt=function(t){function e(e){var n=t.call(this)||this;return n.firstOperand=e,n}return __extends(e,t),e.prototype.evalAndAdvance=function(t,e,n){this.bindResult(this.firstOperand),t.setValue(this.firstOperand);var r=this.getNext();r&&t.setNext(r)},e}(dt),vt=new mt,bt=new mt,wt=function(t){function e(e){var n=t.call(this)||this;return n.payload=e,n}return __extends(e,t),e.prototype.eqv=function(t){return t instanceof e&&this.payload===t.payload},e.prototype.getPayload=function(){return this.payload},e.prototype.setPayload=function(t){this.payload=t},e.prototype.clone=function(e){var n=t.prototype.clone.call(this,e);return n.setPayload(this.payload),n},e.prototype.isEqual=function(t){return t instanceof e&&this.payload===t.payload},e.prototype.unwrap=function(){return this.payload},e}(mt),xt=function(t){function e(e){return t.call(this,e)||this}return __extends(e,t),e.prototype.shouldUnquote=function(){return","===this.payload.charAt(0)},e.prototype.shouldUnquoteSplice=function(){return this.payload.charAt(1)===ct},e.prototype.fixParserSensitiveIds=function(t){if(ht(this.payload)){var e=t.getRenameBinding(this.payload);e&&this.setPayload(e)}},e.prototype.toProcCallLike=function(){return new Nt(this)},e}(wt),Nt=function(t){function e(e,n){var r=t.call(this,n)||this;return r.firstOperand=e,r}return __extends(e,t),e.prototype.evalAndAdvance=function(t,e,n){var r=this.tryIdentifier_(this.firstOperand);null!==r&&(this.bindResult(r),t.setValue(r));var i=this.getNext();i&&t.setNext(i)},e.prototype.tryIdentifier_=function(t){var e=this.getEnv();return e&&e.get(t.getPayload())},e}(dt),St=function(){function t(t){void 0===t&&(t=null),this.parent=t,this.bindings={}}return t.prototype.addRenameBinding=function(t){var e=ft();return this.bindings[t]=e,e},t.prototype.getRenameBinding=function(t){return this.bindings[t]||(this.parent?this.parent.getRenameBinding(t):null)},t.prototype.wasUsed=function(){for(var t in this.bindings)return!0;return!1},t}(),Ct=function(){function t(){this.first=null,this.last=null}return t.prototype.isEmpty=function(){return!this.first},t.prototype.appendSibling=function(t){return this.first?(this.last.setNextSibling(t),this.last=t.lastSibling()):(this.first=t,this.last=t.lastSibling()),this},t.prototype.toSiblings=function(){return this.first},t.prototype.toList=function(t){var e=new t(this.first);return this.last&&e&&this.last.setParent(e),e},t}(),Pt=function(t){function e(){var e=t.call(this)||this;return e.firstChild=null,e.cdrHelper=null,e.qqLevel=void 0,e}return __extends(e,t),e.prototype.getFirstChild=function(){return this.firstChild},e.prototype.setFirstChild=function(t){this.firstChild=t},e.prototype.getQQLevel=function(){return this.qqLevel},e.prototype.clone=function(e){var n=t.prototype.clone.call(this,e);if(this.firstChild){var r=new Ct;this.forEachChild(function(t){return r.appendSibling(t.clone(n))}),n.firstChild=r.toSiblings()}return n},e.prototype.isEqual=function(t){var n,r;for(n=this.firstChild,r=t.firstChild;n&&r;n=n.getNextSibling(),r=r.getNextSibling())if(n instanceof e&&r instanceof e&&!n.isEqual(r))return!1;return!(n||r)},e.prototype.fixParserSensitiveIds=function(e){if(this.hasParse(y))this.fixParserSensitiveIdsLambda_(e);else if(this.hasParse(p))this.fixParserSensitiveIdsDef_(e);else for(var n=this.firstChild;n;n=n.getNextSibling())n.fixParserSensitiveIds(e);t.prototype.fixParserSensitiveIds.call(this,e)},e.prototype.fixParserSensitiveIdsLambda_=function(t){var e=this.at(g),n=new St(t);if(e instanceof xt){var r=e.getPayload();ht(r)&&e.setPayload(n.addRenameBinding(r))}else e.forEachChild(function(t){var e=t,r=e.getPayload();ht(r)&&e.setPayload(n.addRenameBinding(r))});e.getNextSibling().fixParserSensitiveIds(n)},e.prototype.fixParserSensitiveIdsDef_=function(t){var e,n=this.at(H);if(n)ht(e=n.getPayload())&&n.setPayload(t.addRenameBinding(e));else{for(var r=this.firstChild.getNextSibling(),i=r.firstChild,o=new St(t),s=i.getNextSibling();s;s=s.getNextSibling()){var a=s;ht(e=a.getPayload())&&a.setPayload(o.addRenameBinding(e))}r.getNextSibling().fixParserSensitiveIds(o);var u=i.getPayload();ht(u)&&i.setPayload(t.addRenameBinding(u))}},e.prototype.at=function(t){for(var e=this.firstChild;e;e=e.getNextSibling())if(e.peekParse()===t)return e;return null},e.prototype.setCdrHelper=function(t){return this.cdrHelper=t,this},e.prototype.getCdrHelper=function(){return this.cdrHelper},e.prototype.firstSublist=function(){for(var t=this.firstChild;t;t=t.getNextSibling())if(t instanceof e)return t;return null},e.prototype.resetDesugars=function(){t.prototype.resetDesugars.call(this),this.forEachChild(function(t){return t.resetDesugars()})},e.prototype.forEachChild=function(t){for(var e=this.getFirstChild();e;e=e.getNextSibling())t(e)},e.prototype.mapChildren=function(t){for(var e=[],n=this.getFirstChild();n;n=n.getNextSibling())e.push(t(n));return e},e.prototype.replaceChildren=function(t,n){for(var r=this.firstChild,i=null;r;i=r,r=r.getNextSibling())if(t(r)){var o=r.getNextSibling();r.setNextSibling(null),(r=n(r))?(i?i.setNextSibling(r):this.firstChild=r,r.getNextSibling()&&(r=r.lastSibling()),r.setNextSibling(o)):(i.setNextSibling(o),r=i)}else r instanceof e&&r.replaceChildren(t,n);return this},e.prototype.setQuasiquotationLevel=function(t){return this.forEachChild(function(n){n instanceof e&&n.setQuasiquotationLevel(t)}),this},e}(mt),_t=function(){function t(t,e){this.type=t,this.msg=e}return t.prototype.equals=function(t){return this.type===t.type},t.unboundVariable=function(e){return new t(pt.UNBOUND_VARIABLE,e+" is not defined")},t.tooFewVarargs=function(e,n,r){return new t(pt.TOO_FEW_VARARGS,e+": want >= "+n+" args, got "+r)},t.tooManyVarargs=function(e,n,r){return new t(pt.TOO_MANY_VARARGS,e+": want <= "+n+" args, got "+r)},t.incorrectNumArgs=function(e,n,r){return new t(pt.INCORRECT_NUM_ARGS,e+": want "+n+" args, got "+r)},t.internalInterpreterError=function(e){return new t(pt.INTERNAL_INTERPRETER_ERROR,e)},t.macro=function(e,n){return new t(pt.MACRO,"macro "+e+": "+n)},t.unimplementedOption=function(e){return new t(pt.UNIMPLEMENTED_OPTION,"unimplemented: "+e)},t.quasiquote=function(e){return new t(pt.QUASIQUOTE,e)},t.illegalEmptyApplication=function(e){return new t(pt.ILLEGAL_EMPTY_APPLICATION,e)},t.parse=function(e){return new t(pt.PARSE,"parse error: "+e)},t.immutable=function(e){return new t(pt.IMMUTABLE,e)},t.scan=function(e){return new t(pt.SCAN,"scan error: "+e)},t}();!function(t){t.ARGUMENT_TYPE_ERROR="argument type error",t.ILLEGAL_EMPTY_APPLICATION="illegal empty application",t.IMMUTABLE="immutable error",t.INCORRECT_NUM_ARGS="incorrect number of args",t.INTERNAL_INTERPRETER_ERROR="internal interpreter error",t.MACRO="macro error",t.NOT_A_PROCEDURE="not a procedure",t.PARSE="parse error",t.READ="read error",t.QUASIQUOTE="quasiquote error",t.SCAN="scan error",t.TOO_FEW_VARARGS="too few varargs",t.TOO_MANY_VARARGS="too many varargs",t.UNBOUND_VARIABLE="unbound variable",t.UNIMPLEMENTED_OPTION="unimplemented option"}(pt||(pt={}));var Lt=function(t){function e(){return t.call(this)||this}return __extends(e,t),e}(Pt),Rt=function(t){function e(e){var n=t.call(this)||this;return n.dirty=!1,n.dotted=!1,e&&n.setFirstChild(e),n}return __extends(e,t),e.prototype.markDirty=function(){this.dirty=!0},e.prototype.markDotted=function(){this.dotted=!0},e.prototype.isImproperList=function(){return this.dotted},e.prototype.eqv=function(t){if(this.dotted)return this===t;if(!(t instanceof Pt))return!1;if(this===t||t instanceof e&&!this.getFirstChild()&&!t.getFirstChild())return!0;var n=this.getCdrHelper(),r=t.getCdrHelper();return n&&r?n.equals(r):n&&t instanceof Pt?n.resolvesTo(t):!!r&&r.resolvesTo(this)},e.prototype.car=function(){return this.getFirstChild()},e.prototype.cdr=function(){var t=this.getFirstChild().getNextSibling();return t?t.getNextSibling()||!this.dirty?(t.getNextSibling()===t&&t.setNextSibling(null),(new Ct).appendSibling(t).toList(this.dotted?At:e)):t:(new Ct).toList(e)},e}(Lt),At=function(t){function e(e){var n=t.call(this)||this;return e&&n.setFirstChild(e),n}return __extends(e,t),e.prototype.isImproperList=function(){return!0},e.prototype.car=function(){return this.getFirstChild()},e.prototype.cdr=function(){var t,n=this.getFirstChild().getNextSibling();return n?((t=n.getNextSibling()?(new Ct).appendSibling(n).toList(e):n)instanceof Pt&&t.setCdrHelper(new Et(this,n)),t):(new Ct).toList(Rt)},e}(Lt),Et=function(){function t(t,e){this.head=t,this.startOfCdr=e}return t.prototype.setCar=function(t){if(this.head.isImmutable())throw _t.immutable(this.head.toString());this.head.getFirstChild().setNextSibling(t)},t.prototype.setCdr=function(t){if(this.head.isImmutable())throw _t.immutable(this.head.toString());if(this.startOfCdr.setNextSibling(t),!(t instanceof Rt)){var e=this;do{e.head instanceof Rt&&e.head.markDotted()}while(e=e.head.getCdrHelper())}},t.prototype.equals=function(t){return this.head===t.head&&this.startOfCdr===t.startOfCdr},t.prototype.resolvesTo=function(t){return!!t&&this.head===t&&this.startOfCdr===t.getFirstChild()},t}(),kt=function(t){function e(e){return t.call(this,e)||this}return __extends(e,t),e.prototype.getMacro=function(){return this.payload.setIsLetOrLetrecSyntax()},e}(wt),It=function(t){function e(e){return t.call(this,e)||this}return __extends(e,t),e.prototype.eqv=function(t){return this===t},e.prototype.unwrap=function(){return this},e}(wt);function Ot(t){var e=t.at(H);if(e){var n=t.at(d);return e.setNextSibling(null),(new Ct).appendSibling(e).appendSibling(n).toList(Rt)}var r=t.getFirstChild().getNextSibling();e=r.getFirstChild();var i=r.getNextSibling();r.setFirstChild(e.getNextSibling());var o=function s(t,e){var n=new Ct;return n.appendSibling(new xt(X)),e.isImproperList()&&!e.getFirstChild().getNextSibling()?n.appendSibling(new xt(e.getFirstChild().getPayload())):(e.setNextSibling(null),n.appendSibling(e)),n.appendSibling(t),n.toList(Rt)}(i,r);return e.setNextSibling(null),(new Ct).appendSibling(e).appendSibling(o).toList(Rt)}var qt=function(t){function e(e){var n=t.call(this)||this;return n.isArrayBacked=e instanceof Array,n.isArrayBacked?n.array=e:(n.array=[],n.setFirstChild(e)),n}return __extends(e,t),e.prototype.vectorLength=function(){return this.isArrayBacked||this.convertVectorToArrayBacked(),this.array.length},e.prototype.vectorRef=function(t){return this.isArrayBacked||this.convertVectorToArrayBacked(),this.array[t]},e.prototype.vectorSet=function(t,e){this.isArrayBacked||this.convertVectorToArrayBacked(),this.array[t]=e},e.prototype.convertVectorToArrayBacked=function(){var t=this;this.forEachChild(function(e){return t.array.push(e)}),this.isArrayBacked=!0},e}(Pt),Tt=function(){function t(t,e,n){this.letSyntaxEnv=t,this.patternIds=e,this.templateRenameCandidates=n,this.bindings={},this.children=[],this.curChild=0,this.renameInTemplate=new Set}return t.prototype.resetCurChild=function(){return this.curChild=0,this},t.prototype.addTemplateBinding=function(t,e){var n=this;if(t in this.bindings)throw _t.internalInterpreterError("invariant incorrect");if(e instanceof kt){var r=ft();this.letSyntaxEnv.addBinding(r,e.getMacro()),this.bindings[t]=new xt(r)}else this.bindings[t]=e;e instanceof xt?this.maybeRenameId(e):e instanceof Pt&&e.forEachChild(function(t){return n.maybeRenameId(t)})},t.prototype.maybeRenameId=function(t){var e=this;if(t instanceof xt){var n=t.getPayload();this.templateRenameCandidates.has(n)&&this.renameInTemplate.add(n)}else t instanceof Pt&&t.forEachChild(function(t){return e.maybeRenameId(t)})},t.prototype.addChildBindings=function(t){return this.children.push(t),this},t.prototype.hasNoneOf=function(t){for(var e in t.bindings)if(e in this.bindings)return!1;return!0},t.prototype.addOrIncorporateChild=function(t){return this.incorporateChild(t)||this.addChildBindings(t)},t.prototype.incorporateChild=function(t){if(t.children.length>0)return null;for(var e=0,n=this.children;e<n.length;e++){var r=n[e];if(r.hasNoneOf(t)){for(var i in t.bindings)r.addTemplateBinding(i,t.bindings[i]);return this}}return null},t.prototype.getNextChild=function(){return this.curChild<this.children.length?this.children[this.curChild++]:(this.curChild=0,null)},t.prototype.resolveDatum=function(t){if(t instanceof xt){var e=t.getPayload(),n=this.bindings[e];return n?n.clone():void 0===this.patternIds[e]&&t.clone()}return t.clone()},t.prototype.getPatternIds=function(){return this.patternIds},t.prototype.getTemplateRenameCandidates=function(){return this.templateRenameCandidates},t.prototype.wasRenamed=function(t){return this.renameInTemplate.has(t)},t}(),Ft=function(){function t(t){this.subtransformer=t}return t.prototype.matchInput=function(t,e,n,r,i){t||i.addChildBindings(new Tt(r,i.getPatternIds(),i.getTemplateRenameCandidates()));for(var o=t;o;o=o.getNextSibling()){var s=new Tt(r,i.getPatternIds(),i.getTemplateRenameCandidates());if(!this.subtransformer.matchInput(o,e,n,r,s))return!1;i.addOrIncorporateChild(s)}return!0},t.prototype.toDatum=function(t){for(var e,n,r=new Ct;(e=t.getNextChild())&&(n=this.subtransformer.toDatum(e));)r.appendSibling(n);return t.resetCurChild(),r.toSiblings()},t.prototype.collectNestingLevels=function(t,e){this.subtransformer.collectNestingLevels(t+1,e)},t}(),Mt=function(t){function e(e){return t.call(this,e)||this}return __extends(e,t),e}(wt),Bt=function(t){function e(e){return t.call(this,e)||this}return __extends(e,t),e}(wt);function Dt(t){switch(typeof t){case"boolean":return new Mt(t);case"number":return new Bt(t);case"object":return t;case"string":return new xt(t);default:throw _t.internalInterpreterError("cannot deduce type from value "+t+": noninjective mapping from values to types")}}var Ut=function(t){function e(e){return t.call(this,e)||this}return __extends(e,t),e.prototype.deref=function(){return this.payload},e}(wt),zt=function(t){function e(e){var n=t.call(this)||this;return e&&n.setFirstChild(e.setImmutable()),n}return __extends(e,t),e.prototype.car=function(){return Vt},e.prototype.cdr=function(){return new Rt(this.getFirstChild())},e.prototype.fixParserSensitiveIds=function(){},e.prototype.toProcCallLike=function(){return new Ht(this)},e}(Lt),Vt=new xt(rt),Ht=function(t){function e(e,n){var r=t.call(this,n)||this;return r.firstOperand=e,r}return __extends(e,t),e.prototype.evalAndAdvance=function(t,e,n){var r=this.tryQuote(this.firstOperand);null!==r&&(this.bindResult(r),t.setValue(r));var i=this.getNext();i&&t.setNext(i)},e.prototype.tryQuote=function(t){var e=this.getEnv(),n=t.replaceChildren(function(t){return t instanceof xt&&t.shouldUnquote()},function(t){var n=e.get(t.getPayload()),r=null===n?bt:Dt(n);if(r instanceof Ut&&(r=r.deref()),t instanceof xt&&t.shouldUnquoteSplice()){if(!(r instanceof Rt))throw _t.quasiquote(r+" is not a list");r=r.getFirstChild()?r.getFirstChild():null}return r});return n instanceof Pt&&n.getFirstChild()?n.getFirstChild():Vt},e}(dt);function Gt(){return new Xt}function Qt(){return new $t}function jt(){return new Kt}var Yt=function(){function t(t){this.ctor=t,this.subtransformers=[]}return t.prototype.addSubtransformer=function(t){return this.subtransformers.push(t),this},t.prototype.getName=function(){return this.subtransformers[0].getDatum().getPayload()},t.prototype.collectNestingLevels=function(t,e){this.subtransformers.forEach(function(n){return n.collectNestingLevels(t,e)})},t.prototype.couldMatch=function(t){return!1},t.prototype.toDatum=function(t){var e=this.toSiblingBuffer(t);return e&&e.toList(this.ctor)},t.prototype.matchInput=function(t,e,n,r,i){var o,s=this.subtransformers.length,a=this.subtransformers[s-1]instanceof Ft&&this.subtransformers[s-1];if(!this.couldMatch(t))return!1;var u=0;for(o=t.getFirstChild();o&&(u!==s-1||!a);o=o.getNextSibling(),++u){if(u>=s)return!1;if(!this.subtransformers[u].matchInput(o,e,n,r,i))return!1}return a?!(!t.getFirstChild()&&s>1)&&a.matchInput(o,e,n,r,i):u===s},t.prototype.toSiblingBuffer=function(t){for(var e=new Ct,n=0,r=this.subtransformers;n<r.length;n++){var i=r[n].toDatum(t);if(!1===i)return null;i&&e.appendSibling(i)}return e},t}(),Wt=function(t){function e(){return t.call(this,zt)||this}return __extends(e,t),e.prototype.collectNestingLevels=function(){},e}(Yt),Kt=function(t){function e(){return t.call(this,qt)||this}return __extends(e,t),e.prototype.couldMatch=function(t){return t instanceof qt},e}(Yt),Xt=function(t){function e(){return t.call(this,Rt)||this}return __extends(e,t),e.prototype.couldMatch=function(t){return t instanceof Rt},e}(Yt),$t=function(t){function e(){return t.call(this,At)||this}return __extends(e,t),e.prototype.couldMatch=function(t){return t instanceof Rt||t.isImproperList()},e.prototype.matchInput=function(t,e,n,r,i){var o,s=this.subtransformers.length,a=this.subtransformers[s-1]instanceof Ft&&this.subtransformers[s-1];if(!this.couldMatch(t))return!1;var u=0;for(o=t.getFirstChild();o&&u!==s-1;o=o.getNextSibling(),++u){if(u>=s)return!1;if(!this.subtransformers[u].matchInput(o,e,n,r,i))return!1}if(a)return!(!t.getFirstChild()&&s>1)&&a.matchInput(o,e,n,r,i);var c=null;return t instanceof Rt?c=(new Ct).appendSibling(o).toList(Rt):t.isImproperList()&&(c=o.getNextSibling()?(new Ct).appendSibling(o).toList(At):o),this.subtransformers[u].matchInput(c,e,n,r,i)},e}(Yt),Jt=function(){function t(t){this.transformerName=t,this.namesToEllipsisLevels={},this.renameCandidates=new Set}return t.prototype.recordPatternId=function(t,e){t!==this.transformerName&&(this.namesToEllipsisLevels[t]=e)},t.prototype.recordTemplateId=function(t,e){var n=t in this.namesToEllipsisLevels?this.namesToEllipsisLevels[t]:-1;if(-1===n&&t!==this.transformerName)ht(t)||this.renameCandidates.add(t);else if(n!==e&&t!==this.transformerName)throw _t.macro(this.transformerName,t+" is at ellipsis level "+n+" in pattern but at ellipsis level "+e+" in template")},t.prototype.getPatternIds=function(){return this.namesToEllipsisLevels},t.prototype.getRenameCandidates=function(){return this.renameCandidates},t}(),Zt=function(){function t(t,e){this.pattern=t,this.template=e,this.name=t.getName();var n=new Jt(this.name);this.pattern.collectNestingLevels(0,n),this.template.collectNestingLevels(0,n),this.patternIds=n.getPatternIds(),this.templateRenameCandidates=n.getRenameCandidates()}return t.prototype.matchInput=function(t,e,n,r,i){return this.pattern.matchInput(t,e,n,r,i)},t.prototype.getName=function(){return this.name},t.prototype.getTemplate=function(){return this.template},t.prototype.getPatternIds=function(){return this.patternIds},t.prototype.getTemplateRenameCandidates=function(){return this.templateRenameCandidates},t}(),te=function(){function t(t,e,n,r){void 0===r&&(r=[]),this.definitionEnv=n,this.transformers=r,this.literalIdentifiers=new Set,this.isLetOrLetrecSyntax_=!1;for(var i=t;i;i=i.getNextSibling())this.literalIdentifiers.add(i.getPayload());if(!r.length)for(var o=e;o;o=o.getNextSibling()){var s=o,a=s.at(C).desugar(n),u=s.at(B).desugar(n),c=new Zt(a,u);this.transformers.push(c)}}return t.prototype.setIsLetOrLetrecSyntax=function(){return this.isLetOrLetrecSyntax_=!0,this},t.prototype.isLetOrLetrecSyntax=function(){return this.isLetOrLetrecSyntax_},t.prototype.setDefinitionEnv=function(t){this.definitionEnv=t},t.prototype.clone=function(e){return new t(null,null,e,this.transformers)},t.prototype.allPatternsBeginWith=function(t){for(var e=0,n=this.transformers;e<n.length;e++)if(n[e].getName()!==t)return!1;return!0},t.prototype.transcribe=function(t,e,n){for(var r,i,o=function(o){if(r=new Tt(e,o.getPatternIds(),o.getTemplateRenameCandidates()),o.matchInput(t,s.literalIdentifiers,s.definitionEnv,e,r)&&(i=o.getTemplate().toDatum(r))){for(var a=n(i).parse(R),u={},c=0,l=o.getTemplateRenameCandidates().keys();c<l.length;c++){var f=l[c];if(s.definitionEnv.hasBindingRecursive(f))e.addBinding(f,s.definitionEnv);else if(!ht(f)){var h=ft();if(u[f]=h,r.wasRenamed(f)&&e.hasBindingRecursive(f)){var p=e.get(f);null!==p&&e.addBinding(h,p)}}}if(!a)throw _t.parse(i);return(new Ct).appendSibling(a).toList(Rt).replaceChildren(function(t){return t instanceof xt&&t.getPayload()in u},function(t){return t.setPayload(u[t.getPayload()]),t}),{value:a}}},s=this,a=0,u=this.transformers;a<u.length;a++){var c=o(u[a]);if("object"==typeof c)return c.value}throw _t.macro(this.transformers[0].getName(),"no pattern match for input "+t)},t.prototype.evaluate=function(t,e,n,r){var i=e.getEnv(),o=i.child(),s=this.transcribe(t,o,r),a=e.getNext();i&&a&&!a.getEnv()&&a.setStartingEnv(i);var u=s.desugar(o,!0);u.setStartingEnv(o);var c=u.getLast();a&&c.setNext(a),c.setResultName(e.getResultName()),n.setNext(u)},t}(),ee=function(){function t(t){this.datum=t}return t.prototype.matchInput=function(t,e,n,r,i){return this.datum instanceof xt?(i.addTemplateBinding(this.datum.getPayload(),t),!0):t.isEqual(this.datum)},t.prototype.toDatum=function(t){return t.resolveDatum(this.datum)},t.prototype.getDatum=function(){return this.datum},t.pattern=function(t){return new ne(t)},t.template=function(t){return new re(t)},t}(),ne=function(t){function e(e){return t.call(this,e)||this}return __extends(e,t),e.prototype.collectNestingLevels=function(t,e){this.datum instanceof xt&&e.recordPatternId(this.datum.getPayload(),t)},e}(ee),re=function(t){function e(e){return t.call(this,e)||this}return __extends(e,t),e.prototype.collectNestingLevels=function(t,e){this.datum instanceof xt&&e.recordTemplateId(this.datum.getPayload(),t)},e}(ee),ie=function(t){function e(e){var n=t.call(this)||this;return n.firstOperand=e,n}return __extends(e,t),e.prototype.evalAndAdvance=function(t,e,n){var r=this.getEnv().get(this.firstOperand.getNextSibling().getPayload());this.checkForImproperSyntaxAssignment(r),this.mutateEnv(this.firstOperand.getPayload(),r),t.setValue(bt),this.bindResult(bt);var i=this.getNext();i&&t.setNext(i)},e.prototype.checkForImproperSyntaxAssignment=function(t){if(t instanceof te&&!t.isLetOrLetrecSyntax())throw _t.internalInterpreterError("TODO bl")},e.prototype.mutateEnv=function(t,e){this.getEnv().mutate(t,e,!1)},e.create=function(t,n){return new e((new Ct).appendSibling(new xt(t)).appendSibling(new xt(n)).toSiblings())},e}(dt),oe=function(t){function e(e,n,r){var i=t.call(this)||this;return i.testResultName=e,i.consequent=n,i.alternate=r,i.consequentLastContinuable=i.consequent.getLast(),i.alternateLastContinuable=i.alternate.getLast(),i}return __extends(e,t),e.prototype.setStartingEnv=function(t){this.consequent.getEnv()||this.consequent.setStartingEnv(t),this.alternate.getEnv()||this.alternate.setStartingEnv(t)},e.prototype.getEnv=function(){return null},e.prototype.evalAndAdvance=function(t,e,n){!1===e.get(this.testResultName)?(this.alternateLastContinuable.setNext(this.getNext()),this.alternateLastContinuable.setResultName(this.getResultName()),t.setNext(this.alternate),this.consequent.clearEnv()):(this.consequentLastContinuable.setNext(this.getNext()),this.consequentLastContinuable.setResultName(this.getResultName()),t.setNext(this.consequent),this.alternate.clearEnv())},e}(dt),se=function(){function t(){this.firstProcCallLike=null,this.lastProcCallLike=null}return t.prototype.appendProcCallLike=function(t){this.firstProcCallLike?this.lastProcCallLike.setNext(t):this.firstProcCallLike=t,this.lastProcCallLike=t.getLast()},t.prototype.toContinuable=function(){return this.firstProcCallLike},t}(),ae=function(t){function e(e){var n=t.call(this)||this;return e&&n.setFirstChild(e),n}return __extends(e,t),e.prototype.setQuasiquotationLevel=function(e){return this.qqLevel=e,t.prototype.setQuasiquotationLevel.call(this,e-1)},e}(Pt),ue=function(t){function e(e){var n=t.call(this)||this;return e&&n.setFirstChild(e),n}return __extends(e,t),e.prototype.setQuasiquotationLevel=function(e){return this.qqLevel=e,t.prototype.setQuasiquotationLevel.call(this,e-1)},e}(Pt),ce=function(t){function e(e){var n=t.call(this)||this;return n.setFirstChild(e),n}return __extends(e,t),e.prototype.eqv=function(t){return this.isEqual(t)},e.prototype.processQuasiquote=function(t,e){var n=new se,r=this.qqLevel;this.replaceChildren(function(t){return(t instanceof ae||t instanceof ue)&&t.getQQLevel()===r},function(r){var i=e(r.getFirstChild()).parse(d).desugar(t,!0),o=(r instanceof ae?",":",@")+fe++;return i.getLast().setResultName(o),n.appendProcCallLike(i),new xt(o)});var i=new zt(this.getFirstChild());return n.appendProcCallLike(i.toProcCallLike()),n.toContinuable()},e.prototype.setQuasiquotationLevel=function(e){return this.qqLevel=e+1,t.prototype.setQuasiquotationLevel.call(this,this.qqLevel)},e.prototype.toProcCallLike=function(){return new le(this)},e}(Pt),le=function(t){function e(e,n){var r=t.call(this,n)||this;return r.firstOperand=e,r}return __extends(e,t),e.prototype.evalAndAdvance=function(t,e,n){var r=this.tryQuasiquote(this.firstOperand,n);r&&t.setNext(r)},e.prototype.tryQuasiquote=function(t,e){var n=t.processQuasiquote(this.getEnv(),e),r=this.getNext();return r&&n.append(r),n},e}(dt),fe=0,he=function(){function t(t,e){this.lastResultName=t,this.nextContinuable=e}return t.prototype.evaluate=function(e,n,r){n.getEnv().addBinding(this.lastResultName,e),r.setValue(e),this.nextContinuable&&r.setNext(this.nextContinuable),t.repairInfiniteLoop(n,r)},t.repairInfiniteLoop=function(t,e){for(var n=e.getNextProcCallLike(),r=void 0;n;r=n,n=n.getNext())if(n===t)return void(r&&r.setNext(n.getNext()))},t}();function pe(t,e,n,r,i){return new _t(pt.ARGUMENT_TYPE_ERROR,n+": argument "+e+": want "+r+"', got "+i)}function de(t,e){return new _t(pt.NOT_A_PROCEDURE,t)}var ge=function(t){function e(e,n){var r=t.call(this,n)||this;return r.name=e,r}return __extends(e,t),e.prototype.getName=function(){return this.name},e}(wt),me=function(){function t(){}return t.prototype.evaluate=function(t,e,n,r){},t}(),ye=function(t){function e(e,n,r){var i=t.call(this,r)||this;return i.operatorName=e,i.firstOperand=n,i}return __extends(e,t),e.prototype.getFirstOperand=function(){return this.firstOperand},e.prototype.reconstructDatum=function(){var t=new xt(this.operatorName.getPayload());return this.firstOperand&&t.setNextSibling(this.firstOperand),(new Ct).appendSibling(t).toList(Rt)},e.prototype.operandsInContinuationPassingStyle=function(){for(var t=this.firstOperand;t;t=t.getNextSibling())if(t instanceof mt){if(t instanceof Rt&&!t.getFirstChild())throw _t.illegalEmptyApplication(this.operatorName.getPayload());if(!(t instanceof wt||t instanceof zt||t instanceof qt))return!1}return!0},e.prototype.cpsify=function(t,n){for(var r,i=new se,o=new Ct,s=this.firstOperand;s;s=s.getNextSibling())if(s.resetDesugars(),s instanceof zt)o.appendSibling(s.clone());else if(s instanceof ce)r=s.processQuasiquote(this.getEnv(),n),o.appendSibling(new xt(r.getLast().getResultName())),i.appendProcCallLike(r);else{if(s.isImproperList())throw _t.internalInterpreterError("TODO bl");if((r=s.desugar(this.getEnv()))instanceof dt)o.appendSibling(new xt(r.getLast().getResultName())),i.appendProcCallLike(r);else{var a=s.clone();o.appendSibling(a)}}i.appendProcCallLike(new e(this.operatorName,o.toSiblings()));var u=i.toContinuable(),c=u.getLast(),l=this.getNext();l&&c.setNext(l),c.setResultName(this.getResultName()),t.setNext(u)},e.prototype.evalAndAdvance=function(t,e,n){var r=this.getEnv().getProcedure(this.operatorName.getPayload());if(r instanceof me)if(this.operandsInContinuationPassingStyle()){var i=this.evalArgs();r.evaluate(i,this,t,e)}else this.cpsify(t,n);else if(r instanceof te){var o=this.reconstructDatum();r.evaluate(o,this,t,n)}else{if(!(r instanceof he))throw r instanceof mt?de(this.operatorName.getPayload()):_t.internalInterpreterError("ProcCall: don't know what to do with "+r);var s=this.evalArgs()[0];r.evaluate(s,this,t)}},e.prototype.evalArgs=function(){var t;if(t=this.evalArgsCallWithValues())return t;for(var e=[],n=this.firstOperand;n;n=n.getNextSibling())if(n instanceof xt){var r=n.getPayload(),i=this.getEnv().get(r);if(i instanceof te&&!i.isLetOrLetrecSyntax())throw _t.macro(r,"bad syntax");e.push(null===i?bt:i)}else if(n instanceof zt)e.push(n.getFirstChild());else if(n instanceof ge)e.push(n);else{if(!(n instanceof mt))throw _t.internalInterpreterError("unexpected datum "+n);e.push(n.clone())}return e},e.prototype.evalArgsCallWithValues=function(){if(this.firstOperand instanceof xt&&!this.firstOperand.getNextSibling()){var t=this.getEnv().get(this.firstOperand.getPayload());if(t instanceof Array)return t}return null},e}(dt),ve=function(t){function e(e){return t.call(this,e)||this}return __extends(e,t),e.prototype.mutateEnv=function(t,e){this.getEnv().mutate(t,e,!0)},e.of=function(t,n){return new e((new Ct).appendSibling(new xt(t)).appendSibling(new xt(n)).toSiblings())},e}(ie),be=function(t){function e(e){return t.call(this,e)||this}return __extends(e,t),e.prototype.checkForImproperSyntaxAssignment=function(){},e.of=function(t,n){return new e((new Ct).appendSibling(new xt(t)).appendSibling(new xt(n)).toSiblings())},e}(ve),we=function(t){function e(e,n,r,i){var o=t.call(this)||this;return o.formalsArray=e,o.name=i,o.env=r.child(),o.body=n&&o.setupBody(n),o.last=o.body&&o.body.getLast(),o}return __extends(e,t),e.prototype.getName=function(){return this.name},e.prototype.setupBody=function(t){var e=new Ne,n=e.collectLetrecBindings(t);if(n.isEmpty())return e.getLast().sequence(this.env);var r=new Rt(n.toSiblings());return r.setNextSibling(e.getLast()),new ye(new xt("letrec"),r)},e.prototype.cloneWithEnv=function(t){var e=new this.constructor(this.formalsArray,null,t,""+xe++);return e.env.setClosuresFrom(this.env),e.body=this.body,e.last=this.last,e},e.prototype.setContinuation=function(t){this.last&&(this.last.setNext(t.getNext()),this.last.setResultName(t.getResultName()))},e.prototype.isTailCall=function(t){return this.last===t},e.prototype.toString=function(){return"proc:"+this.name},e.prototype.setEnv=function(t){this.body&&this.body.setStartingEnv(t)},e.prototype.checkNumArgs=function(t){if(t!==this.formalsArray.length)throw _t.incorrectNumArgs(this.toString(),this.formalsArray.length,t)},e.prototype.bindArgs=function(t,e){for(var n=0;n<this.formalsArray.length;++n)e.addBinding(this.formalsArray[n],t[n])},e.prototype.evaluate=function(t,e,n,r){var i=e.getEnv(),o=this.isTailCall(e)?i.allowRedefs():this.env.child().addClosuresFrom(this.env),s=e.getNext();i&&s&&!s.getEnv()&&s.setStartingEnv(i),this.setContinuation(e),this.checkNumArgs(t.length),this.bindArgs(t,o),this.setEnv(o),n.setNext(this.body)},e}(me),xe=0,Ne=function(){function t(){this.bindings=new Ct,this.last=null}return t.prototype.collectLetrecBindings=function(t){var e,n=this;for(e=t;e&&e.peekParse()===p;e=e.getNextSibling()){var r=e.getFirstChild();r instanceof xt&&r.getPayload()===j?this.bindings.appendSibling(Ot(e)):e.forEachChild(function(t){return n.collectLetrecBindingsForChild(t)})}return this.last=e,this.bindings},t.prototype.collectLetrecBindingsForChild=function(t){var e=this;if(t instanceof Pt&&!(t instanceof zt)){var n=t.getFirstChild();n instanceof xt&&n.getPayload()===j?this.bindings.appendSibling(Ot(t)):t instanceof Pt&&t.forEachChild(function(t){return e.collectLetrecBindingsForChild(t)})}},t.prototype.getLast=function(){return this.last},t}(),Se=function(t){function e(e,n,r,i){return t.call(this,e,n,r,i)||this}return __extends(e,t),e.prototype.checkNumArgs=function(t){var e=this.formalsArray.length-1;if(t<e)throw _t.tooFewVarargs(this.toString(),e,t)},e.prototype.bindArgs=function(t,e){var n,r;for(r=0;r<this.formalsArray.length-1;++r)e.addBinding(n=this.formalsArray[r],t[r]);if(this.formalsArray.length>0){n=this.formalsArray[r];for(var i=new Ct,o=r;o<t.length;++o)i.appendSibling(Dt(t[o]));e.addBinding(n,i.toList(Rt))}},e}(we),Ce=function(){function t(t){this.prev=null,this.next=t}return t.create=function(e){return new t(e)},t.prototype.getNextDatum=function(){return this.next},t.prototype.advanceTo=function(t){this.next=t},t.prototype.advanceToChild=function(){this.prev=this.next,this.next=this.next.getFirstChild()},t.prototype.advanceToNextSibling=function(){this.prev=this.next,this.next=this.next.getNextSibling()},t.prototype.maybeAdvanceToNextSiblingOfParent=function(){return!this.next&&(this.next=this.prev.getParent()&&this.prev.getParent().getNextSibling(),!0)},t}(),Pe=function(){function t(t){this.grammar=t}return t.prototype.one=function(t){return"string"==typeof t?new _e(t):new Le(t,this.grammar)},t.prototype.zeroOrMore=function(t){return new Re(t,0,this.grammar)},t.prototype.oneOrMore=function(t){return new Re(t,1,this.grammar)},t.prototype.choice=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return new Ee(t)},t.prototype.seq=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return new ke(t)},t.prototype.list=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=[];return n.push(new _e(Z)),n.push.apply(n,t),n.push(new _e(it)),new ke(n)},t.prototype.dottedList=function(t,e){var n=[new _e(Z),t,new _e(W),e];return new ke(n)},t.prototype.vector=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=[];return n.push(new _e(et)),n.push.apply(n,t),n.push(new _e(it)),new ke(n)},t.prototype.matchDatum=function(t){return new Ae(t)},t}(),_e=function(){function t(t){this.terminal=t}return t.prototype.desugar=function(t){return this},t.prototype.match=function(t){if(this.terminal===it)return t.maybeAdvanceToNextSiblingOfParent();var e=t.getNextDatum(),n=!1;switch(this.terminal){case Z:n=e instanceof Rt;break;case tt:n=e instanceof At;break;case et:n=e instanceof qt;break;case st:n=e instanceof zt;break;case"`":n=e instanceof ce;break;case",":n=e instanceof ae;break;case",@":n=e instanceof ue;break;default:return e instanceof wt&&e.getPayload()===this.terminal&&(t.advanceToNextSibling(),!0)}return n&&t.advanceToChild(),n},t}(),Le=function(){function t(t,e){this.nonterminal=t,this.grammar=e,this.desugarFunc=null}return t.prototype.desugar=function(t){return this.desugarFunc=t,this},t.prototype.match=function(t){var e=this.grammar.ruleFor(this.nonterminal).match(t);return e instanceof mt&&(e.setParse(this.nonterminal),this.desugarFunc&&e.setDesugar(this.desugarFunc),t.advanceTo(e.getNextSibling())),e},t}(),Re=function(){function t(t,e,n){this.nonterminal=t,this.minRepetitions=e,this.grammar=n}return t.prototype.match=function(t){for(var e,n=0;e=this.grammar.ruleFor(this.nonterminal).match(t);)e.setParse(this.nonterminal),++n;return n>=this.minRepetitions},t}(),Ae=function(){function t(t){this.predicate=t}return t.prototype.match=function(t){var e=t.getNextDatum();return!(!e||!this.predicate(e)||(t.advanceToNextSibling(),0))},t}(),Ee=function(){function t(t){this.rules=t}return t.prototype.match=function(t){for(var e,n=0,r=this.rules;n<r.length;n++)if(e=r[n].match(t))return e;return!1},t}(),ke=function(){function t(t){this.desugarFunc=null,this.rules=function e(t){var e=t.findIndex(function(t){return t instanceof _e&&t.terminal===W});if(-1===e)return t;for(var n=e-1;n>=0;--n){var r=t[n];if(r instanceof _e&&r.terminal===Z){t[n]=new _e(tt);break}}return t.splice(e,2),t}(t)}return t.prototype.match=function(t){for(var e=t.getNextDatum(),n=0,r=this.rules;n<r.length;n++)if(!r[n].match(t))return t.advanceTo(e),!1;var i=e&&e.getNextSibling();return t.advanceTo(i),e instanceof mt&&this.desugarFunc&&e.setDesugar(this.desugarFunc),e||!1},t.prototype.desugar=function(t){return this.desugarFunc=t,this},t}(),Ie=function(){function t(t){this.datumStream=Ce.create(t)}return t.prototype.parse=function(t){void 0===t&&(t=R);var e=qe[t].match(this.datumStream);if(e){if(t===R&&e!=vt&&!e.peekParse())return null;e.setParse(t)}return t===R?Be(e):e},t}(),Oe=!1,qe={},Te=new Pe({ruleFor:function(t){return qe[t]}});qe[d]=Te.choice(Te.one(H),Te.one(b),Te.one(y),Te.one(c),Te.one(s),Te.one(A).desugar(function(t,e){return t.setQuasiquotationLevel(1)}),Te.list(Te.one(Q),Te.oneOrMore(d)).desugar(function(t,e){return t.at(d).sequence(e)}),Te.one(w),Te.one(L),Te.one(x)),qe[H]=Te.seq(Te.matchDatum(function(t){var e=t instanceof xt;return e&&ht(t.getPayload())&&(Oe=!0),e})),qe[b]=Te.choice(Te.one(O),Te.one(E)),qe[E]=Te.seq(Te.one(st),Te.one(f)),qe[f]=Te.seq(Te.matchDatum(function(t){return!0})),qe[O]=Te.seq(Te.matchDatum(function(t){var e=t instanceof wt&&!(t instanceof xt)||t instanceof qt;return t instanceof It&&t.setImmutable(),e})),qe[L]=Te.list(Te.one(S),Te.zeroOrMore(N)).desugar(function(t,e){var n=t.at(S),r=t.at(N);if(n instanceof xt)return new ye(n,r);var i=n.desugar(e),o=i.getLast(),s=o.getResultName();return o.setNext(new ye(new xt(s),r)),i}),qe[S]=Te.one(d),qe[N]=Te.one(d),qe[y]=Te.list(Te.one(X),Te.one(g),Te.zeroOrMore(p),Te.oneOrMore(d)).desugar(function(t,e){var n,r=t.at(g),i=!1;r instanceof Rt?n=r.mapChildren(function(t){return t.getPayload()}):r.isImproperList()?(n=r.mapChildren(function(t){return t.getPayload()}),i=!0):(n=[r.getPayload()],i=!0);var o=Me(),s=i?new Se(n,r.getNextSibling(),e,o):new we(n,r.getNextSibling(),e,o);return e.addClosure(o,s),new xt(o).toProcCallLike()}),qe[g]=Te.choice(Te.list(Te.zeroOrMore(H)),Te.one(H),Te.dottedList(Te.oneOrMore(H),Te.one(H))),qe[p]=Te.choice(Te.list(Te.one(j),Te.one(H),Te.one(d)).desugar(function(t,e){var n=t.at(H),r=n.getNextSibling().desugar(e,!0),i=r.getLast(),o=i.getResultName();return i.setNext(ve.of(n.getPayload(),o)),r}),Te.list(Te.one(j),Te.list(Te.oneOrMore(H)),Te.zeroOrMore(p),Te.oneOrMore(d)).desugar(function(t,e){var n=Ot(t).getFirstChild(),r=n.getNextSibling().getFirstChild().getNextSibling(),i=r.mapChildren(function(t){return t.getPayload()}),o=Me();return e.addBinding(o,new we(i,r.getNextSibling(),e,n.getPayload())),ve.of(n.getPayload(),o)}),Te.list(Te.one(j),Te.dottedList(Te.oneOrMore(H),Te.one(H)),Te.zeroOrMore(p),Te.oneOrMore(d)).desugar(function(t,e){var n=Ot(t).getFirstChild(),r=n.getNextSibling().getFirstChild().getNextSibling(),i=r instanceof Pt?r.mapChildren(function(t){return t.getPayload()}):[r.getPayload()],o=Me();return e.addBinding(o,new Se(i,r.getNextSibling(),e,n.getPayload())),ve.of(n.getPayload(),o)}),Te.list(Te.one(Q),Te.zeroOrMore(p)).desugar(function(t,e){var n=t.at(p);return n&&n.sequence(e)})),qe[c]=Te.choice(Te.list(Te.one(K),Te.one(U),Te.one(l),Te.one(o)).desugar(function(t,e){var n=t.at(U).desugar(e,!0),r=t.at(l).desugar(e,!0),i=t.at(o).desugar(e,!0),s=n.getLast(),a=new oe(s.getResultName(),r,i);return s.setNext(a),n}),Te.list(Te.one(K),Te.one(U),Te.one(l)).desugar(function(t,e){var n=t.at(U).desugar(e,!0),r=t.at(l).desugar(e,!0),i=n.getLast(),o=new oe(i.getResultName(),r,bt.toProcCallLike());return i.setNext(o),n})),qe[U]=Te.one(d),qe[l]=Te.one(d),qe[o]=Te.one(d),qe[s]=Te.list(Te.one(ot),Te.one(H),Te.one(d)).desugar(function(t,e){var n=t.at(H),r=n.getNextSibling().desugar(e,!0),i=r.getLast(),o=i.getResultName();return i.setNext(ie.create(n.getPayload(),o)),r}),qe[A]=Te.seq(Te.one("`"),Te.one(k)),qe[k]=Te.choice(Te.matchDatum(function(t){return t instanceof wt}),Te.one(v),Te.one(G),Te.one(V)),qe[v]=Te.choice(Te.list(Te.zeroOrMore(I)),Te.dottedList(Te.oneOrMore(I),Te.one(I)),Te.seq(Te.one(st),Te.one(k)),Te.one(A)),qe[G]=Te.vector(Te.zeroOrMore(I)),qe[V]=Te.seq(Te.one(","),Te.one(k)),qe[I]=Te.choice(Te.seq(Te.one(k)),Te.one(q)),qe[q]=Te.seq(Te.one(",@"),Te.one(k)),qe[x]=Te.list(Te.one(m),Te.zeroOrMore(f)).desugar(function(t,e){return new ye(t.at(m),t.at(f))}),qe[m]=Te.seq(Te.matchDatum(function(t){return t instanceof xt})),qe[w]=Te.choice(Te.list(Te.one($),Te.list(Te.zeroOrMore(M)),Te.zeroOrMore(p),Te.oneOrMore(d)).desugar(function(t,e){return De(t,e,"let")}),Te.list(Te.one(J),Te.list(Te.zeroOrMore(M)),Te.zeroOrMore(p),Te.oneOrMore(d)).desugar(function(t,e){return De(t,e,"letrec")})),qe[M]=Te.list(Te.one(m),Te.one(z)),qe[z]=Te.list(Te.one("syntax-rules"),Te.list(Te.zeroOrMore(_)),Te.zeroOrMore(F)).desugar(function(t,e){var n=t.firstSublist().at(_),r=t.at(F);return new te(n,r,e)}),qe[F]=Te.list(Te.one(C),Te.one(B)),qe[C]=Te.choice(Te.list(Te.oneOrMore(C),Te.one("...")).desugar(function(t,e){for(var n=Gt(),r=t.at(C);r;r=r.getNextSibling()){var i=r.getNextSibling();if(i instanceof wt&&"..."===i.getPayload()){n.addSubtransformer(new Ft(r.desugar(e)));break}n.addSubtransformer(r.desugar(e))}return n}),Te.vector(Te.oneOrMore(C),Te.one("...")).desugar(function(t,e){for(var n=jt(),r=t.at(C);r;r=r.getNextSibling()){var i=r.getNextSibling();if(i instanceof xt&&"..."===i.getPayload()){n.addSubtransformer(new Ft(r.desugar(e)));break}n.addSubtransformer(r.desugar(e))}return n}),Te.one(_).desugar(function(t){return ee.pattern(t)}),Te.list(Te.zeroOrMore(C)).desugar(function(t,e){for(var n=Gt(),r=t.at(C);r;r=r.getNextSibling())n.addSubtransformer(r.desugar(e));return n}),Te.seq(Te.one(Z),Te.oneOrMore(C),Te.one(W),Te.one(C),Te.one(it)).desugar(function(t,e){for(var n=Qt(),r=t.at(C);r;r=r.getNextSibling())n.addSubtransformer(r.desugar(e));return n}),Te.vector(Te.zeroOrMore(C)).desugar(function(t,e){for(var n=jt(),r=t.at(C);r;r=r.getNextSibling())n.addSubtransformer(r.desugar(e));return n}),Te.one(P).desugar(function(t){return ee.pattern(t)})),qe[P]=Te.seq(Te.matchDatum(function(t){return t instanceof wt&&!(t instanceof xt)})),qe[B]=Te.choice(Te.one(_).desugar(function(t){return ee.template(t)}),Te.seq(Te.one("...")),Te.one(D).desugar(function(t){return ee.template(t)}),Te.dottedList(Te.oneOrMore(B),Te.one(B)).desugar(function(t,e){for(var n=Qt(),r=t.at(B);r;r=r.getNextSibling()){var i=r.getNextSibling();i instanceof xt&&"..."===i.getPayload()?(n.addSubtransformer(new Ft(r.desugar(e))),r=r.getNextSibling()):n.addSubtransformer(r.desugar(e))}return n}),Te.list(Te.zeroOrMore(B)).desugar(function(t,e){for(var n=Gt(),r=t.at(B);r;r=r.getNextSibling()){var i=r.getNextSibling();i instanceof xt&&"..."===i.getPayload()?(n.addSubtransformer(new Ft(r.desugar(e))),r=r.getNextSibling()):n.addSubtransformer(r.desugar(e))}return n}),Te.vector(Te.zeroOrMore(B)).desugar(function(t,e){for(var n=jt(),r=t.at(B);r;r=r.getNextSibling()){var i=r.getNextSibling();i instanceof xt&&"..."===i.getPayload()?(n.addSubtransformer(new Ft(r.desugar(e))),r=r.getNextSibling()):n.addSubtransformer(r.desugar(e))}return n}),Te.seq(Te.one(st),Te.one(B)).desugar(function(t,e){return function n(){return new Wt}().addSubtransformer(t.at(B).desugar(e))})),qe[D]=Te.one(P),qe[_]=Te.seq(Te.matchDatum(function(t){return t instanceof xt&&"..."!==t.getPayload()})),qe[R]=Te.seq(Te.zeroOrMore(u)).desugar(function(t,e){return t===vt?t:t.sequence(e)}),qe[u]=Te.choice(Te.one(p),Te.one(T),Te.one(p),Te.one(T),Te.list(Te.one(Q),Te.zeroOrMore(u)).desugar(function(t,e){var n=t.at(u);return n&&n.sequence(e)}),Te.one(a)),qe[a]=Te.one(d),qe[T]=Te.list(Te.one(Y),Te.one(m),Te.one(z)).desugar(function(t,e){var n=t.at(m).getPayload(),r=t.at(z).desugar(e);if(!r.allPatternsBeginWith(n))throw _t.macro(n,"all patterns must begin with "+n);var i=Me();return e.addBinding(i,r),be.of(n,i)});var Fe=0;function Me(){return"proc"+Fe++}function Be(t){if(!t||!Oe)return t;Oe=!1;var e=new St(null);return t.fixParserSensitiveIds(e),e.wasUsed()?new Ie(t).parse():t}function De(t,e,n){var r=new Ct;t.firstSublist().forEachChild(function(t){var n=t.at(m).clone(),i=t.at(z).desugar(e),o=new Ct;o.appendSibling(n),o.appendSibling(new kt(i)),r.appendSibling(o.toList(Rt))});var i=new Ct;return i.appendSibling(r.toList(Rt)).appendSibling(t.firstSublist().getNextSibling()),new ye(new xt(n),i.toSiblings())}var Ue=function(t){function e(e){return t.call(this,e)||this}return __extends(e,t),e.prototype.unwrap=function(){return this},e}(wt),ze=function(){function t(t){this.grammar=t}return t.prototype.one=function(t){return new Ve(t,this.grammar)},t.prototype.zeroOrMore=function(t){return new Ge(t,0,this.grammar)},t.prototype.oneOrMore=function(t){return new Ge(t,1,this.grammar)},t.prototype.onePrimitive=function(t){return new Qe(t)},t.prototype.seq=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return new je(t)},t.prototype.choice=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return new Ye(t)},t}(),Ve=function(){function t(t,e){this.type=t,this.grammar=e}return t.prototype.match=function(t){var e=this.type instanceof i?this.grammar.ruleFor(this.type):null;return e?e.match(t):this.matchTerminal(t)},t.prototype.matchTerminal=function(t){return t.nextToken()===this.type?He:null},t}(),He=new mt,Ge=function(){function t(t,e,n){this.grammar=n,this.type=t,this.repetition=e}return t.prototype.match=function(t){for(var e,n=new Ct,r=this.grammar.ruleFor(this.type),i=t.checkpoint(),o=0;e=r.match(t);)n.appendSibling(e),++o;return o>=this.repetition?n.toSiblings()||vt:(t.restore(i),null)},t}(),Qe=function(){function t(t){this.ctor=t}return t.prototype.match=function(t){var e=t.nextToken();return e instanceof this.ctor?e:null},t}(),je=function(){function t(t){this.rules=t,this.ctor=null}return t.prototype.named=function(t){return this.ctor=t,this},t.prototype.match=function(t){for(var e=new Ct,n=t.checkpoint(),r=0,i=this.rules;r<i.length;r++){var o=i[r].match(t);if(o!==He&&o!==vt){if(!o)return t.restore(n),null;e.appendSibling(o)}}return function s(t){if(!(t instanceof Rt&&t.getFirstChild()))return t;var e=t.getFirstChild();if(!(e instanceof wt))return t;var n=e.getNextSibling();switch(e.getPayload()){case rt:return new zt(n);case nt:return new ce(n);case at:return new ae(n);case ut:return new ue(n);default:return t}}(e.toList(this.ctor))},t}(),Ye=function(){function t(t){this.rules=t}return t.prototype.match=function(t){for(var e=0,n=this.rules;e<n.length;e++){var r,i=n[e],o=t.checkpoint();if(r=i.match(t))return r;t.restore(o)}return null},t}();function We(t){return new $e(t)}var Ke=new Map,Xe=new ze({ruleFor:function(t){return Ke.get(t)}});Ke.set(f,Xe.choice(Xe.onePrimitive(xt),Xe.onePrimitive(Mt),Xe.onePrimitive(Bt),Xe.onePrimitive(Ue),Xe.onePrimitive(It),Xe.seq(Xe.one(Z),Xe.zeroOrMore(f),Xe.one(it)).named(Rt),Xe.seq(Xe.one(Z),Xe.oneOrMore(f),Xe.one(W),Xe.one(f),Xe.one(it)).named(At),Xe.seq(Xe.one(et),Xe.zeroOrMore(f),Xe.one(it)).named(qt),Xe.seq(Xe.one(st),Xe.one(f)).named(zt),Xe.seq(Xe.one("`"),Xe.one(f)).named(ce),Xe.seq(Xe.one(","),Xe.one(f)).named(ae),Xe.seq(Xe.one(",@"),Xe.one(f)).named(ue))),Ke.set(h,Xe.zeroOrMore(f));var $e=function(){function t(t){this.scanner=t}return t.prototype.read=function(){var t=Ke.get(h).match(this.scanner),e=this.scanner.nextToken();if(e)throw new _t(pt.READ,"read error: "+e);return t},t}(),Je=function(){function t(t){this.enclosingEnv=t,this.bindings={},this.closures={},this.redefsOk=!1,this.sealed=!1}return t.prototype.seal=function(){this.sealed=!0},t.prototype.allowRedefs=function(){return this.redefsOk=!0,this},t.prototype.clone=function(){if(this.enclosingEnv)throw _t.internalInterpreterError("clone should only be used during interpreter bootstrapping");var e=new t(null);for(var n in this.bindings){var r=this.bindings[n];e.bindings[n]=r instanceof te?r.clone(e):r}return e},t.prototype.hasBindingRecursive=function(t){return t in this.bindings||!!this.enclosingEnv&&this.enclosingEnv.hasBindingRecursive(t)},t.prototype.get=function(e){if(e in this.bindings){var n=this.bindings[e];return n instanceof t&&n.hasBindingRecursive(e)?n.get(e):n instanceof te?n:n instanceof he||n instanceof me?new ge(e,n):n===bt?n:n instanceof mt?new Ut(n):n}if(e in this.closures)return this.closures[e];if(this.enclosingEnv)return this.enclosingEnv.get(e);throw _t.unboundVariable(e)},t.prototype.getProcedure=function(e){if(e in this.bindings){var n=this.bindings[e];if(n instanceof t)return n.getProcedure(e);if(n instanceof he||n instanceof te||n instanceof me)return n;throw n instanceof mt?de(e):_t.internalInterpreterError("getProcedure: don't know what to do with binding "+e)}return this.enclosingEnv?this.enclosingEnv.getProcedure(e):null},t.prototype.addClosuresFrom=function(t){for(var e in t.closures)this.addBinding(e,t.closures[e].cloneWithEnv(this));return this},t.prototype.addClosure=function(t,e){if(this.sealed)throw _t.internalInterpreterError("tried to bind "+t+" in sealed environment");if(this.closures[t])throw _t.internalInterpreterError("invariant incorrect");this.closures[t]=e},t.prototype.bindingIsAcceptable_=function(t){return!(t in this.bindings)||this.redefsOk||t.charAt(0)===ct},t.prototype.addBinding=function(t,e){if(this.sealed)throw _t.internalInterpreterError("tried to bind "+t+" in sealed environment "+this);if(!this.bindingIsAcceptable_(t))throw _t.internalInterpreterError("redefining "+t+" in same env, not allowed");e instanceof te&&e.setDefinitionEnv(this),this.bindings[t]=e instanceof wt?e.unwrap():e},t.prototype.mutate=function(e,n,r){var i=this.bindings[e];if(null!=i||r)i instanceof t?i.mutate(e,n,r):(delete this.bindings[e],this.addBinding(e,n));else{if(!this.enclosingEnv)throw _t.unboundVariable(e);this.enclosingEnv.mutate(e,n,r)}},t.prototype.setClosuresFrom=function(t){this.closures=t.closures},t.prototype.child=function(){return new t(this)},t.prototype.toString=function(){return"<environment-specifier>"},t}(),Ze=function(){function t(t){this.name=t}return t.prototype.getName=function(){return this.name},t}(),tn=new Ze("boolean"),en=new Ze("char"),nn=new Ze("environment-specifier"),rn=new Ze("input-port"),on=new Ze("number"),sn=new Ze("output-port"),an=new Ze("pair"),un=new Ze("procedure"),cn=new Ze("string"),ln=new Ze("symbol"),fn=new Ze("vector"),hn=Object.freeze({BOOLEAN:tn,CHARACTER:en,ENVIRONMENT_SPECIFIER:nn,INPUT_PORT:rn,NUMBER:on,OUTPUT_PORT:sn,PAIR:an,PROCEDURE:un,STRING:cn,SYMBOL:ln,VECTOR:fn});function pn(t){return new mn(t)}var dn=/[esfdli#\/]/i,gn=/[i@]/i,mn=function(){function t(t){this.text=t,this.start=0,this.tokenRegex=function e(){var t="(?:[a-z]|[\\!\\$%&\\*/\\:<\\=\\>\\?\\^_~])",e="(?:[esfdl][\\-\\+]?\\d+)",n="(?:(?:[01]+#*)\\/(?:[01]+#*)|(?:[01]+#*))",r="(?:(?:[0-7]+#*)\\/(?:[0-7]+#*)|(?:[0-7]+#*))",i="(?:(?:\\d+#*)\\/(?:\\d+#*)|(?:\\.\\d+#*"+e+"?|\\d+\\.\\d*#*"+e+"?|\\d+#+\\.#*"+e+"?|(?:\\d+#*)"+e+"?)|(?:\\d+#*))",o="(?:(?:[\\da-f]+#*)\\/(?:[\\da-f]+#*)|(?:[\\da-f]+#*))",s="(?:[\\-\\+]?"+n+")",a="(?:[\\-\\+]?"+r+")",u="(?:[\\-\\+]?"+i+")",c="(?:[\\-\\+]?"+o+")";return new RegExp("((?:(?:#d(?:#i|#e)?|(?:#i|#e)?#d|(?:#i|#e))?(?:"+u+"@"+u+"|"+u+"[\\+\\-]"+i+"i|"+u+"[\\+\\-]i|[\\\\-]+"+i+"i|[\\+\\-]i|"+u+"))|(?:(?:#x(?:#i|#e)?|(?:#i|#e)?#x)(?:"+c+"@"+c+"|"+c+"[\\+\\-]"+o+"i|"+c+"[\\+\\-]i|[\\\\-]+"+o+"i|[\\+\\-]i|"+c+"))|(?:(?:#o(?:#i|#e)?|(?:#i|#e)?#o)(?:"+a+"@"+a+"|"+a+"[\\+\\-]"+r+"i|"+a+"[\\+\\-]i|[\\\\-]+"+r+"i|[\\+\\-]i|"+a+"))|(?:(?:#b(?:#i|#e)?|(?:#i|#e)?#b)(?:"+s+"@"+s+"|"+s+"[\\+\\-]"+n+"i|"+s+"[\\+\\-]i|[\\\\-]+"+n+"i|[\\+\\-]i|"+s+')))|(#t|#f)|(#\\\\space|#\\\\newline|#\\\\.)|("(?:[^"\\\\]|\\\\\\"|\\\\\\\\)*")|((?:'+t+"(?:"+t+"|\\d|[\\+\\-\\.@])*)|(?:\\+|\\-|\\.\\.\\.))|([\\(\\)'`\\.]|#\\(|,@|,)|((?:[ \n\r\t]|;.*$|;.*[\n\r])+)","gi")}(),this.needDelimiter=!1,this.readyTokens=[],this.nextTokenIndex=0}return t.prototype.shouldMatchAgain=function(t){if(t){if(this.tokenRegex.lastIndex>this.start+t[0].length)throw _t.scan(this.text.substr(this.start,this.tokenRegex.lastIndex-this.start));this.start=this.tokenRegex.lastIndex;var e=!!t[7];return e&&(this.needDelimiter=!1),e}return!1},t.prototype.checkpoint=function(){return this.nextTokenIndex},t.prototype.nextToken=function(){for(;this.nextTokenIndex>=this.readyTokens.length;){var t=this.readNextToken();this.readyTokens.push(t)}return this.readyTokens[this.nextTokenIndex++]},t.prototype.restore=function(t){for(var e=t+1;e<this.readyTokens.length;++e){var n=this.readyTokens[e];n instanceof mt&&n.setNextSibling(null)}this.nextTokenIndex=t},t.prototype.readNextToken=function(){var t;do{t=this.tokenRegex.exec(this.text)}while(this.shouldMatchAgain(t));if(t)return this.matchToToken(t);if(this.start!==this.text.length)throw _t.scan(this.text.substr(this.start));return this.tokenRegex.lastIndex=this.text.length,t},t.prototype.matchToToken=function(t){var e=t[0];if(this.needDelimiter&&!t[6])throw _t.scan(this.text.substr(this.tokenRegex.lastIndex));if(t[6])return this.needDelimiter=!1,e;if(t[5])return this.needDelimiter=!0,new xt(e);if(t[2])return this.needDelimiter=!1,new Mt("#t"===e||"#T"===e);if(t[3])return this.needDelimiter=!0,new Ue(function n(t){var e=t.substr(2);if(1===e.length)return e;if("space"===e.toLowerCase())return" ";if("newline"===e.toLowerCase())return"\n";throw _t.internalInterpreterError("invalid character payload "+t)}(e));if(t[4]){this.needDelimiter=!1;var r=e.substr(1,e.length-2);return new It(r)}if(t[1]){this.needDelimiter=!0;var i=dn.test(e)?function o(t){var e=(t=t.replace(/#i|#e/i,"")).length;if(gn.test(t))throw _t.scan("unsupported number literal: "+t);var n=10;(t=t.replace(/#x/i,"")).length<e?n=16:(t=t.replace(/#d/i,"")).length<e||((t=t.replace(/#o/i,"")).length<e?n=8:(t=t.replace(/#b/i,"")).length<e&&(n=2));var r=(t=t.replace("#","")).split("/");return 2===r.length?parseInt(r[0],n)/parseInt(r[1],n):10===n?parseFloat(t.replace(/[sfdl]/i,"e")):parseInt(t,n)}(e):parseFloat(e);return new Bt(i)}throw _t.internalInterpreterError("invariant incorrect")},t}(),yn=function(t){function e(e){var n=t.call(this)||this;return n.buffer=e,n.leftoverDatum=null,n.buffer=e,n}return __extends(e,t),e.prototype.isCharReady=function(){return!this.buffer.isEmpty()},e.prototype.close=function(){},e.prototype.read=function(){var t=this.readLeftoverDatum();if(t)return t;if(this.buffer.isEmpty())return null;var e=this.buffer.getAndClear();return this.leftoverDatum=We(pn(e)).read(),this.read()},e.prototype.readLeftoverDatum=function(){var t=this.leftoverDatum;return t&&(this.leftoverDatum=t.getNextSibling()),t},e.prototype.peekChar=function(){var t=this.buffer.peekChar();return t?new Ue(t):null},e.prototype.readChar=function(){var t=this.buffer.getChar();return t?new Ue(t):null},e}(t),vn=function(t){function e(e){var n=t.call(this)||this;return n.buffer=e,n.outputs=[],n}return __extends(e,t),e.prototype.write=function(t){this.buffer.append(t),this.outputs.push(t)},e.prototype.dequeueOutput=function(){return this.outputs.shift()||null},e}(n),bn=function(){function t(){this.buffer=""}return t.prototype.isEmpty=function(){return!this.buffer.length},t.prototype.getChar=function(){var t=this.peekChar();return t&&(this.buffer=this.buffer.substr(1)),t},t.prototype.peekChar=function(){return this.buffer.length?this.buffer.charAt(0):null},t.prototype.getAndClear=function(){var t=this.buffer;return this.buffer="",t},t.prototype.append=function(t){this.buffer+=t},t}(),wn=function(){function t(){this.buffers={}}return t.prototype.newInputPort=function(t){return t in this.buffers||(this.buffers[t]=new bn),new yn(this.buffers[t])},t.prototype.newOutputPort=function(t){return t in this.buffers||(this.buffers[t]=new bn),new vn(this.buffers[t])},t}(),xn=function(t){function e(e,n){var r=t.call(this,e,null)||this;return r.continuation=n,r}return __extends(e,t),e.prototype.evalArgs=function(){return[this.continuation]},e}(ye),Nn=function(t){function e(e,n,r){var i=t.call(this,r,n)||this;return i.thunk=e,i}return __extends(e,t),e.prototype.evaluate=function(t,e,n){e.getEnv().addBinding(this.lastResultName,t),n.setValue(t),n.setNext(this.thunk),this.nextContinuable&&this.thunk.append(this.nextContinuable),he.repairInfiniteLoop(e,n)},e}(he),Sn=new mt,Cn=function(){function t(t){this.numArgs=t}return t.prototype.checkNumArgs=function(t,e){if(t!==this.numArgs)throw _t.incorrectNumArgs(e,this.numArgs,t)},t}(),Pn=function(){function t(t){this.min=t}return t.prototype.checkNumArgs=function(t,e){if(t<this.min)throw _t.tooFewVarargs(e,this.min,t)},t}(),_n=function(){function t(t,e){this.minArgs=t,this.maxArgs=e}return t.prototype.checkNumArgs=function(t,e){if(t<this.minArgs)throw _t.tooFewVarargs(e,this.minArgs,t);if(t>this.maxArgs)throw _t.tooManyVarargs(e,this.maxArgs,t)},t}(),Ln=new Cn(1),Rn=new Cn(2),An=new Cn(3),En=new Pn(0),kn=new Pn(1),In=function(){function t(t){this.argtypes=t}return t.prototype.checkAndUnwrapArgs=function(t,e){for(var n=[],r=0;r<this.argtypes.length;++r){var i=t[r],o=this.argtypes[r];if(!Wn[o.getName()+"?"].fn.call(null,i))throw pe(0,r,e,o,Kn(i));n.push(i instanceof wt?i.unwrap():i)}return n},t}(),On=new(function(){function t(){}return t.prototype.checkAndUnwrapArgs=function(t,e){return t},t}()),qn=function(){function t(t){this.type=t}return t.prototype.checkAndUnwrapArgs=function(t,e){var n=this.type;return t.map(function(t,r){if(!Wn[n.getName()+"?"].fn.call(null,t))throw pe(0,r,e,n,Kn(t));return t instanceof wt?t.unwrap():t})},t}(),Tn=function(t){function e(e,n,r){var i=t.call(this)||this;return i.fn=e,i.numArgChecker=n,i.typeChecker=r,i.debugName="",i.numArgChecker=n,i.typeChecker=r,i}return __extends(e,t),e.prototype.setDebugName=function(t){this.debugName=t},e.prototype.toString=function(){return"<proc:"+this.debugName+">"},e.prototype.call=function(t,e,n){this.numArgChecker.checkNumArgs(t.length,this.debugName);var r=this.typeChecker.checkAndUnwrapArgs(t,this.debugName),i=this.fn.apply(null,r);e.bindResult(i),n.setValue(i);var o=e.getNext();o&&n.setNext(o)},e.prototype.evaluate=function(t,e,n,r){t=t.map(Dt);for(var i=0;i<t.length;++i)t[i]instanceof Ut&&(t[i]=t[i].deref());this.call(t,e,n)},e}(me),Fn=function(t){function e(e,n,r){return t.call(this,e,n,r)||this}return __extends(e,t),e.prototype.call=function(t,e,n){this.numArgChecker.checkNumArgs(t.length,this.debugName);var r=this.typeChecker.checkAndUnwrapArgs(t,this.debugName),i=[].concat(n.getInputPort(),n.getOutputPort(),r),o=this.fn.apply(null,i);e.bindResult(o),n.setValue(o);var s=e.getNext();s&&n.setNext(s)},e}(Tn),Mn=function(t){function e(e,n,r){return t.call(this,e,n,r)||this}return __extends(e,t),e.prototype.call=function(t,e,n){this.numArgChecker.checkNumArgs(t.length,this.debugName);var r=this.typeChecker.checkAndUnwrapArgs(t,this.debugName),i=[].concat(r,e,n);this.fn.apply(null,i)},e}(Tn);function Bn(t,e){return new Tn(t,Ln,e?new In([e]):On)}function Dn(t,e,n){var r=[];e&&r.push(e),n&&r.push(n);var i=0===r.length?On:new In(r);return new Tn(t,Rn,i)}function Un(t,e,n,r){var i=[];e&&i.push(e),n&&i.push(n),r&&i.push(r);var o=i.length?new In(i):On;return new Tn(t,An,o)}function zn(t,e){return new Tn(t,En,new qn(e))}function Vn(t,e){return new Tn(t,kn,new qn(e))}function Hn(t,e,n){return new Tn(t,new _n(e,n),On)}function Gn(t){return new Fn(t,new Cn(0),On)}function Qn(t){return new Fn(t,new _n(0,1),On)}function jn(t){return new Fn(t,new _n(1,2),On)}function Yn(t,e){return new Mn(e,new Pn(t),On)}var Wn={};function Kn(t){var e=hn;for(var n in e){var r=e[n],i=r.getName()+"?";if(i in Wn&&Wn[i].fn.call(null,t))return r}throw _t.internalInterpreterError("unknown type: "+t)}Wn["boolean?"]=Bn(function(t){return t instanceof Mt}),Wn["char?"]=Bn(function(t){return t instanceof Ue}),Wn["input-port?"]=Bn(function(e){return e instanceof t}),Wn["null?"]=Bn(function(t){return t instanceof Rt&&!t.getFirstChild()}),Wn["number?"]=Bn(function(t){return t instanceof Bt}),Wn["output-port?"]=Bn(function(t){return t instanceof n}),Wn["pair?"]=Bn(function(t){return t instanceof Lt&&!!t.getFirstChild()}),Wn["port?"]=Bn(function(e){return e instanceof t||e instanceof n}),Wn["procedure?"]=Bn(function(t){return t instanceof ge||t instanceof he}),Wn["string?"]=Bn(function(t){return t instanceof It}),Wn["symbol?"]=Bn(function(t){return t instanceof xt}),Wn["vector?"]=Bn(function(t){return t instanceof qt});var Xn=function(){function t(t,e){this.inputPort=t,this.outputPort=e,this.beforeThunk=null,this.nextContinuable=null,this.value=bt}return t.prototype.clear=function(){this.nextContinuable=null},t.prototype.getBeforeThunk=function(){return this.beforeThunk},t.prototype.setBeforeThunk=function(t){this.beforeThunk=t},t.prototype.getNextProcCallLike=function(){return this.nextContinuable},t.prototype.setNext=function(t){this.nextContinuable=t},t.prototype.getValue=function(){return this.value},t.prototype.setValue=function(t){this.value=t},t.prototype.getInputPort=function(){return this.inputPort},t.prototype.getOutputPort=function(){return this.outputPort},t}();function $n(t,e,n,r){for(var i=t,o=new Xn(n,r),s=e;i;){var a=i.getEnv();!a&&s&&i.setStartingEnv(s),i.evalAndAdvance(o,s,function(t){return new Ie(t)}),s=a=i.getEnv(),i.clearEnv(),i=o.getNextProcCallLike(),o.clear()}return o.getValue()}function Jn(t){return Zn(!0,t)}function Zn(e,r){switch(typeof r){case"number":return""+r;case"boolean":return r?"#t":"#f";case"string":return r;case"object":if(r===bt)return"";if(r===Sn)return"<eof>";if(r instanceof Ut)return Zn(e,r.deref());if(r instanceof Rt||r instanceof At){var i=r.mapChildren(function(t){return Zn(e,t)});return(r instanceof Rt&&r.isImproperList()||r instanceof At)&&i.splice(i.length-1,0,W),""+Z+i.join(" ")+it}if(r instanceof qt){var o=r.mapChildren(function(t){return Zn(e,t)}).join(" ");return et+o+it}if(r instanceof It)return e?'"'+r.getPayload()+'"':r.getPayload();if(r instanceof Ue){if(e){var s=r.getPayload();return" "===s?"#\\space":"\n"===s?"#\\newline":"#\\"+s}return r.getPayload()}return r instanceof zt?st+Zn(e,r.getFirstChild()):r instanceof we?"<proc:"+r.getName()+">":r instanceof t?"<input-port>":r instanceof n?"<output-port>":r instanceof wt?Zn(e,r.unwrap()):r instanceof mt?Zn(e,r):r.toString();default:return""}}var tr=null,er=null,nr=null,rr={};function ir(t,e){for(var n in tr=t,er=e,nr=new wn,rr){var r=rr[n];r.setDebugName(n),e.addBinding(n,r)}}!function or(t){for(var e in Wn)t[e]=Wn[e]}(rr),rr["eqv?"]=rr["eq?"]=Dn(function(t,e){return t.eqv(e)}),rr["="]=zn(function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var n=0;n<t.length-1;++n)if(t[n]!==t[n+1])return!1;return!0},on),rr["/"]=Vn(function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];if(1===t.length)return 1/t[0];for(var n=t[0],r=1;r<t.length;++r)n/=t[r];return n},on),rr["-"]=Vn(function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];if(1===t.length)return-1*t[0];for(var n=t[0],r=1;r<t.length;++r)n-=t[r];return n},on),rr["*"]=zn(function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var n=1,r=0;r<t.length;++r)n*=t[r];return n},on),rr["+"]=zn(function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var n=0,r=0;r<t.length;++r)n+=t[r];return n},on),rr[">="]=zn(function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var n=0;n<t.length-1;++n)if(t[n]<t[n+1])return!1;return!0},on),rr[">"]=zn(function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var n=0;n<t.length-1;++n)if(t[n]<=t[n+1])return!1;return!0},on),rr["<="]=zn(function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var n=0;n<t.length-1;++n)if(t[n]>t[n+1])return!1;return!0},on),rr["<"]=zn(function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var n=0;n<t.length-1;++n)if(t[n]>=t[n+1])return!1;return!0},on),rr.angle=Bn(function(t){throw _t.unimplementedOption("angle")},on),rr.acos=Bn(Math.acos,on),rr.asin=Bn(Math.asin,on),rr.atan=Vn(function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];switch(t.length){case 1:return Math.atan(t[0]);case 2:return Math.atan2(t[0],t[1]);default:throw _t.tooManyVarargs("atan",2,t.length)}},on),rr.ceiling=Bn(Math.ceil,on),rr["complex?"]=Bn(function(t){return t instanceof Bt}),rr.cos=Bn(Math.cos,on),rr["exact?"]=Bn(function(t){return!1},on),rr["exact->inexact"]=Bn(function(t){return t},on),rr.exp=Bn(Math.exp,on),rr.expt=Dn(Math.pow,on,on),rr.floor=Bn(Math.floor,on),rr["imag-part"]=Bn(function(t){throw _t.unimplementedOption("imag-part")},on),rr["inexact?"]=Bn(function(t){return!0},on),rr["inexact->exact"]=Bn(function(t){return t},on),rr.magnitude=Bn(function(t){throw _t.unimplementedOption("magnitude")},on),rr["make-polar"]=Dn(function(t,e){throw _t.unimplementedOption("make-polar")},on,on),rr["make-rectangular"]=Dn(function(t,e){throw _t.unimplementedOption("make-rectangular")},on,on),rr["number->string"]=Bn(function(t){return new It(t+"")},on),rr["integer?"]=Bn(function(t){return t instanceof Bt&&Math.round(t.getPayload())===t.getPayload()}),rr.log=Bn(Math.log,on),rr.modulo=Dn(function(t,e){var n=t%e,r=n;if(t*e>0)return n;if(t>0){for(;r>0;)r+=e;return r}for(;r<0;)r+=e;return r},on,on),rr.quotient=Dn(function(t,e){var n=t/e;return n>0?Math.floor(n):Math.ceil(n)},on,on),rr["rational?"]=Bn(function(t){return t instanceof Bt}),rr["real?"]=Bn(function(t){return t instanceof Bt}),rr["real-part"]=Bn(function(t){throw _t.unimplementedOption("real-part")},on),rr.remainder=Dn(function(t,e){return t%e},on,on),rr.round=Bn(function(t){var e=Math.floor(t),n=Math.abs(t-e),r=Math.ceil(t),i=Math.abs(r-t);return i<n?r:n<i?e:r%2?e:r},on),rr.sin=Bn(Math.sin,on),rr.sqrt=Bn(Math.sqrt,on),rr["string->number"]=Bn(parseFloat,cn),rr.tan=Bn(Math.tan,on),rr.truncate=Bn(function(t){return t>0?Math.floor(t):Math.ceil(t)},on),rr.car=Bn(function(t){return t.car()},an),rr.cdr=Bn(function(t){var e=t.cdr();return e instanceof Pt&&e.setCdrHelper(new Et(t,e.getFirstChild())),e},an),rr.cons=Dn(function(t,e){var n=t.clone(),r=e.clone();if(r instanceof Rt||r.isImproperList()){var i=r.getFirstChild();return r.setFirstChild(n),n.setNextSibling(i),r}return(new Ct).appendSibling(n).appendSibling(r).toList(At)}),rr["set-car!"]=Dn(function(t,e){if(!(t instanceof Rt||t.isImproperList()))throw pe(0,0,"set-car!",an,Kn(t));if(t.isImmutable())throw _t.immutable(t.toString());e.setNextSibling(t.getFirstChild().getNextSibling()),t.setFirstChild(e);var n=t.getCdrHelper();return n&&n.setCar(e),bt}),rr["set-cdr!"]=Dn(function(t,e){if(!(t instanceof Rt||t.isImproperList()))throw pe(0,0,"set-cdr!",an,Kn(t));if(t.isImmutable())throw _t.immutable(t.toString());e instanceof Rt?t.getFirstChild().setNextSibling(e.getFirstChild()):t.getFirstChild().setNextSibling(e);var n=t.getCdrHelper();return n&&n.setCdr(e),t instanceof Rt&&t.markDirty(),bt}),rr["make-vector"]=Hn(function(t,e){if(!(t instanceof Bt))throw pe(0,0,"make-vector",on,Kn(t));var n=t.getPayload();e=e||new Mt(!1);for(var r=[],i=0;i<n;++i)r.push(e.clone());return new qt(r)},1,2),rr["vector-length"]=Bn(function(t){return t.vectorLength()},fn),rr["vector-ref"]=Dn(function(t,e){return t.vectorRef(e)},fn,on),rr["vector-set!"]=Un(function(t,e,n){if(!(t instanceof qt))throw pe(0,0,"vector-set!",fn,Kn(t));if(!(e instanceof Bt))throw pe(0,1,"vector-set!",on,Kn(e));if(t.isImmutable())throw _t.immutable(t.toString());return t.vectorSet(e.getPayload(),n),bt}),rr["symbol->string"]=Bn(function(t){return new It(t).setImmutable()},ln),rr["string->symbol"]=Bn(function(t){return new xt(t.getPayload())},cn),rr["char=?"]=Dn(function(t,e){return t.getPayload()===e.getPayload()},en,en),rr["char<?"]=Dn(function(t,e){return t.getPayload()<e.getPayload()},en,en),rr["char>?"]=Dn(function(t,e){return t.getPayload()>e.getPayload()},en,en),rr["char<=?"]=Dn(function(t,e){return t.getPayload()<=e.getPayload()},en,en),rr["char>=?"]=Dn(function(t,e){return t.getPayload()>=e.getPayload()},en,en),rr["char->integer"]=Bn(function(t){return t.getPayload().charCodeAt(0)},en),rr["integer->char"]=Bn(function(t){return new Ue(String.fromCharCode(t))},on),rr["char-upcase"]=Bn(function(t){return new Ue(t.getPayload().toUpperCase())},en),rr["char-downcase"]=Bn(function(t){return new Ue(t.getPayload().toLowerCase())},en),rr["make-string"]=Hn(function(t,e){for(var n=e?e.getPayload():" ",r=t.getPayload(),i="",o=0;o<r;++o)i+=n;return new It(i)},1,2),rr["string-length"]=Bn(function(t){return t.getPayload().length},cn),rr["string-ref"]=Dn(function(t,e){return new Ue(t.getPayload().charAt(e))},cn,on),rr["string-set!"]=Un(function(t,e,n){if(t.isImmutable())throw _t.immutable(t.getPayload());var r=t.getPayload();return t.setPayload(r.substr(0,e)+n.getPayload()+r.substr(e+1)),bt},cn,on,en),rr.eval=function sr(t){return new Fn(t,new Cn(2),On)}(function(t,e,n,r){if(!(n instanceof mt))throw pe(0,0,"eval",ln,Kn(n));if(!(r instanceof Je))throw pe(0,1,"eval",nn,Kn(r));if(n instanceof ge)return new xt(n.getName());var i=r;n.setNextSibling(null);var o=new Ie(n).parse();if(!o)throw _t.parse(n);return $n(o.desugar(i),i,t,e)}),rr["will-eval?"]=Dn(function(t){try{return rr.eval.fn.call(null,t),!0}catch(t){return!1}}),rr["char-ready?"]=Qn(function(e,n,r){var i=r||e;if(!(i instanceof t))throw pe(0,0,"char-ready?",rn,Kn(i));return i.isCharReady()}),rr["close-input-port"]=Bn(function(t){return t.close(),bt},rn),rr["close-output-port"]=Bn(function(t){return t.close(),bt},sn),rr["current-input-port"]=Gn(function(t,e){return t}),rr["current-output-port"]=Gn(function(t,e){return e}),rr.display=jn(function(t,e,r,i){var o=i||e;if(!(o instanceof n))throw pe(0,1,"display",sn,Kn(o));return o.write(function s(t){return Zn(!1,t)}(r)),bt}),rr["eof-object?"]=Bn(function(t){return t===Sn}),rr["open-input-file"]=Bn(function(t){return nr.newInputPort(t.getPayload())},cn),rr["open-output-file"]=Bn(function(t){return nr.newOutputPort(t.getPayload())},cn),rr["peek-char"]=Qn(function(e,n,r){var i=r||e;if(!(i instanceof t))throw pe(0,0,"peek-char",rn,Kn(i));return i.peekChar()||Sn}),rr.read=Qn(function(e,n,r){var i=r||e;if(!(i instanceof t))throw pe(0,0,"read",rn,Kn(i));return i.read()||Sn}),rr["read-char"]=Qn(function(e,n,r){var i=r||e;if(!(i instanceof t))throw pe(0,0,"read-char",rn,Kn(i));return i.readChar()||Sn}),rr.write=jn(function(t,e,r,i){var o=i||e;if(!(o instanceof n))throw pe(0,1,"write",sn,Kn(o));return o.write(Jn(r)),bt}),rr["write-char"]=jn(function(t,e,r,i){if(!(r instanceof Ue))throw pe(0,0,"write-char",en,Kn(r));var o=i||e;if(!(o instanceof n))throw pe(0,1,"write-char",sn,Kn(o));return o.write(Jn(r)),bt}),rr.apply=Yn(2,function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=t[0];if(!(n instanceof ge))throw pe(0,0,"apply",un,Kn(n));var r=new xt(n.getName()),i=t[t.length-2],o=t[t.length-1],s=t.length-3,a=t[s];if(!(a instanceof Rt))throw pe(0,s,"apply",an,Kn(a));if(1===s){for(var u=new Ct,c=a.getFirstChild();c;c=c.getNextSibling())u.appendSibling(new zt(c));(f=new ye(r,u.toSiblings())).setNext(i.getNext()),f.setResultName(i.getResultName()),o.setNext(f)}else{for(var l=1;l<s-1;++l)t[l].setNextSibling(t[l+1]);var f;t[s-1].setNextSibling(a.getFirstChild()),u=(new Ct).appendSibling(t[1]).toSiblings(),(f=new ye(r,u)).setNext(i.getNext()),f.setResultName(i.getResultName()),o.setNext(f)}return bt}),rr["dynamic-wind"]=function ar(t){return new Mn(t,An,On)}(function(t,e,n,r,i){var o=r,s=new ye(o.getFirstOperand(),null),a=new ye(o.getFirstOperand().getNextSibling().getNextSibling(),null),u=new ye(o.getFirstOperand().getNextSibling(),null);return a.append(new xt(u.getResultName()).toProcCallLike()),a.getLast().setNext(r.getNext()),u.append(a),s.append(u),i.setNext(s),i.setBeforeThunk(new ye(o.getFirstOperand(),null,s.getResultName())),bt}),rr["call-with-values"]=function ur(t){return new Mn(t,Rn,On)}(function(t,e,n,r){var i=n,o=new ye(i.getFirstOperand(),null),s=new ye(i.getFirstOperand().getNextSibling(),new xt(o.getResultName()));return s.setNext(n.getNext()),o.setNext(s),r.setNext(o),bt}),rr["call-with-current-continuation"]=function cr(t){return new Mn(t,Ln,On)}(function(t,e,n){var r=e,i=e.getNext(),o=e.getResultName(),s=n.getBeforeThunk(),a=s?new Nn(s,i,o):new he(o,i),u=new xn(r.getFirstOperand(),a);return i&&u.setNext(i),u.setResultName(e.getResultName()),n.setNext(u),bt}),rr.values=Yn(1,function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=t[t.length-1],r=t[t.length-2],i=t[t.length-2],o=t.length-2;if(1===o)i.getEnv().addBinding(r.getResultName(),t[0]);else{for(var s=[],a=0;a<o;++a)s.push(t[a]);i.getEnv().addBinding(r.getResultName(),s)}var u=r.getNext();return u&&u.setStartingEnv(i.getEnv()),n.setNext(u),bt}),rr["null-environment"]=Bn(function(t){if(5!==t)throw _t.unimplementedOption("(null-environment "+t+")");return tr.child()},on),rr["scheme-report-environment"]=Bn(function(t){if(5!==t)throw _t.unimplementedOption("(scheme-report-environment "+t+")");return er.child()},on);var lr,fr=function(){function t(t,e,n){this.pipeline=t,this.inputPort=e,this.outputPort=n}return t.prototype.evaluate=function(t){return Jn(this.pipeline.Eval(this.pipeline.desugar(this.pipeline.parse(this.pipeline.read(this.pipeline.scan(t)))),this.inputPort,this.outputPort))},t}(),hr=function(){function t(t){this.env=new Je(t)}return t.prototype.scan=function(t){return pn(t)},t.prototype.read=function(t){return We(t).read()},t.prototype.parse=function(t,e){void 0===e&&(e=R);var n=new Ie(t).parse(e);if(!n)throw _t.parse(t);return n},t.prototype.desugar=function(t){return t.desugar(this.env)},t.prototype.Eval=function(t,e,n){return t===vt?bt:$n(t,this.env,e,n)},t}();function pr(t,n){$n(new Ie(We(pn(t)).read()).parse().desugar(n),n,e,r)}function dr(t){lr||(lr=new hr(new Je(null)));try{var e=lr.scan(t),n=lr.parse(lr.read(e));return!e.nextToken()&&!!n}catch(e){var r=t.match(/\(/g),i=t.match(/\)/g);return!(!r||!i||r.length!==i.length)}}var gr=function gr(){this.syntax='\n; Copyright 2011-2014 Brendan Linn\n;\n; This program is free software: you can redistribute it and/or modify\n; it under the terms of the GNU General Public License as published by\n; the Free Software Foundation, either version 3 of the License, or\n; (at your option) any later version.\n;\n; This program is distributed in the hope that it will be useful,\n; but WITHOUT ANY WARRANTY; without even the implied warranty of\n; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n; GNU General Public License for more details.\n;\n; You should have received a copy of the GNU General Public License\n; along with this program.  If not, see <http://www.gnu.org/licenses/>.\n\n\t\t\t\t\t; R5RS 6.5: "Null-environment returns a specifier for an environment that is\n\t\t\t\t\t; empty except for the (syntactic) bindings for all syntactic keywords\n\t\t\t\t\t; defined in this report that are either required or both optional and\n\t\t\t\t\t; supported by the implementation."\n\n(define-syntax cond\n  (syntax-rules (else =>)\n    ((cond (else result1 result2 ...))\n     (begin result1 result2 ...))\n    ((cond (test => result))\n     (let ((temp test))\n       (if temp (result temp))))\n    ((cond (test => result) clause1 clause2 ...)\n     (let ((temp test))\n       (if temp\n\t   (result temp)\n\t   (cond clause1 clause2 ...))))\n    ((cond (test)) test)\n    ((cond (test) clause1 clause2 ...)\n     (let ((temp test))\n       (if temp\n\t   temp\n           (cond clause1 clause2 ...))))\n    ((cond (test result1 result2 ...))\n     (if test (begin result1 result2 ...)))\n    ((cond (test result1 result2 ...)\n           clause1 clause2 ...)\n     (if test\n         (begin result1 result2 ...)\n         (cond clause1 clause2 ...)))))\n\n(define-syntax case\n  (syntax-rules (else)\n    ((case (key ...)\n       clauses ...)\n     (let ((atom-key (key ...)))\n       (case atom-key clauses ...)))\n    ((case key\n       (else result1 result2 ...))\n     (begin result1 result2 ...))\n    ((case key\n       ((atoms ...) result1 result2 ...))\n     (if (memv key \'(atoms ...))\n         (begin result1 result2 ...)))\n    ((case key\n       ((atoms ...) result1 result2 ...)\n       clause clauses ...)\n     (if (memv key \'(atoms ...))\n         (begin result1 result2 ...)\n         (case key clause clauses ...)))))\n\n(define-syntax or\n  (syntax-rules ()\n    ((or) #f)\n    ((or test) test)\n    ((or test1 test2 ...)\n     (let ((x test1))\n       (if x x (or test2 ...))))))\n\n(define-syntax let\n  (syntax-rules ()\n    ((let ((name val) ...) body1 body2 ...)\n     ((lambda (name ...) body1 body2 ...)\n      val ...))\n    ((let tag ((name val) ...) body1 body2 ...)\n     ((letrec ((tag (lambda (name ...)\n                      body1 body2 ...)))\n\ttag) val ...))))\n\n(define-syntax and\n  (syntax-rules ()\n    ((and) #t)\n    ((and test) test)\n    ((and test1 test2 ...)\n     (if test1 (and test2 ...) #f))))\n\n(define-syntax let*\n  (syntax-rules ()\n    ((let* () body1 body2 ...)\n     (let () body1 body2 ...))\n    ((let* ((name1 val1) (name2 val2) ...)\n       body1 body2 ...)\n     (let ((name1 val1))\n       (let* ((name2 val2) ...)\n\t body1 body2 ...)))))\n\n; todo bl this official version seems too pedantic, with\n; the renaming of variables. Is it OK to simplify?\n(define-syntax letrec\n  (syntax-rules ()\n    ((letrec ((var1 init1) ...) body ...)\n     (letrec "generate_temp_names"\n       (var1 ...)\n       ()\n       ((var1 init1) ...)\n       body ...))\n    ((letrec "generate_temp_names"\n       ()\n       (temp1 ...)\n       ((var1 init1) ...)\n       body ...)\n     (let ((var1 \'fuck) ...) ; todo bl\n       (let ((temp1 init1) ...)\n\t (set! var1 temp1)\n\t ...\n\t body ...)))\n    ((letrec "generate_temp_names"\n       (x y ...)\n       (temp ...)\n       ((var1 init1) ...)\n       body ...)\n     (letrec "generate_temp_names"\n       (y ...)\n       (newtemp temp ...)\n       ((var1 init1) ...)\n       body ...))))\n\n(define-syntax do\n  (syntax-rules ()\n    ((do ((var init step ...) ...)\n\t (test expr ...)\n       command ...)\n     (letrec\n\t ((loop\n\t   (lambda (var ...)\n\t     (if test\n\t\t (begin\n\t\t   (if #f #f)\n\t\t   expr ...)\n\t\t (begin\n\t\t   command\n\t\t   ...\n\t\t   (loop (do "step" var step ...)\n\t\t\t ...))))))\n       (loop init ...)))\n    ((do "step" x)\n     x)\n    ((do "step" x y)\n     y)))\n\n(define-syntax delay\n  (syntax-rules ()\n    ((delay expression)\n     (make-promise (lambda () expression)))))\n',this.procedures="\n; Copyright 2011-2014 Brendan Linn\n;\n; This program is free software: you can redistribute it and/or modify\n; it under the terms of the GNU General Public License as published by\n; the Free Software Foundation, either version 3 of the License, or\n; (at your option) any later version.\n;\n; This program is distributed in the hope that it will be useful,\n; but WITHOUT ANY WARRANTY; without even the implied warranty of\n; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n; GNU General Public License for more details.\n;\n; You should have received a copy of the GNU General Public License\n; along with this program.  If not, see <http://www.gnu.org/licenses/>.\n\n; This file contains definitions for almost all the procedures in chapter 6\n; of R5RS listed as \"library procedures\".\n;\n; In a few cases, I have chosen to implement library procedures\n; as primitive procedures. These decisions are explained in comments\n; in this file.\n;\n; This file also contains some helper functions that were useful in\n; implementing the library procedures.\n\n(define (equal? x y) ; p. 19\n  (cond\n   ((and (pair? x) (pair? y))\n    (and (equal? (car x) (car y))\n\t (equal? (cdr x) (cdr y))))\n   ((and (vector? x) (vector? y))\n    (equal? (vector->list x) (vector->list y)))\n   ((and (string? x) (string? y))\n    (equal? (string->list x) (string->list y)))\n   (else (eqv? x y))))\n\n(define (zero? z) (= z 0)) ; p. 22\n\n(define (positive? x) (> x 0)) ; p. 22\n\n(define (negative? x) (< x 0)) ; p. 22\n\n(define (odd? n) (= 1 (remainder n 2))) ; p. 22\n\n(define (even? n) (= 0 (remainder n 2))) ; p. 22\n\n(define (max x . ys) ; p. 22\n  (if (null? ys)\n      x\n      (foldl\n       (lambda (y z) (if (< y z) z y))\n       x\n       ys)))\n\n(define (min x . ys) ; p. 22\n  (if (null? ys)\n      x\n      (foldl\n       (lambda (y z) (if (< y z) y z))\n       x\n       ys)))\n\n(define (abs x) (if (> x 0) x (- x))) ; p. 22\n\n(define (euclid p q) ; helper, not in R5RS\n  (cond\n   ((= q 0) p)\n   ((< p q) (euclid q p))\n   (else (euclid q (modulo p q)))))\n\n(define (gcd . ns) ; p. 23\n  (foldl (lambda (l r) (euclid l (abs r))) 0 ns))\n\n(define (lcm2 p q) ; helper, not in R5RS\n  (/ (* p q) (euclid p q)))\n\n(define (lcm . ns) ; p. 23\n  (foldl (lambda (l r) (lcm2 l (abs r))) 1 ns))\n\n(define (not p) (if p #f #t)) ; p. 25\n\n; Note: boolean? is listed as a library procedure, and can\n; easily be implemented as\n; (define (boolean? p)\n;   (or (eqv? p #t) (eqv? p #f)))\n; In this implementation, all of the basic type predicates\n; are primitive procedures because they are used to do\n; rudimentary (\"primitive\"?) typechecking on the arguments to\n; primitive procedures.\n\n(define (foldr f start xs) ; helper function, not in R5RS\n  (if (null? xs)\n      start\n      (f (car xs) (foldr f start (cdr xs)))))\n\n(define (compose . fs) ; helper function, not in R5RS\n  (foldr\n   (lambda (l r) (lambda (x) (l (r x))))\n   (lambda (y) y)\n   fs))\n\n(define caar (compose car car)) ; p. 26\n(define cadr (compose car cdr))\n(define cdar (compose cdr car))\n(define cddr (compose cdr cdr))\n\n(define caaar (compose car car car)) ; p. 26\n(define caadr (compose car car cdr))\n(define cadar (compose car cdr car))\n(define caddr (compose car cdr cdr))\n(define cdaar (compose cdr car car))\n(define cdadr (compose cdr car cdr))\n(define cddar (compose cdr cdr car))\n(define cdddr (compose cdr cdr cdr))\n\n(define caaaar (compose car car car car)) ; p. 26\n(define caaadr (compose car car car cdr))\n(define caadar (compose car car cdr car))\n(define caaddr (compose car car cdr cdr))\n(define cadaar (compose car cdr car car))\n(define cadadr (compose car cdr car cdr))\n(define caddar (compose car cdr cdr car))\n(define cadddr (compose car cdr cdr cdr))\n(define cdaaar (compose cdr car car car))\n(define cdaadr (compose cdr car car cdr))\n(define cdadar (compose cdr car cdr car))\n(define cdaddr (compose cdr car cdr cdr))\n(define cddaar (compose cdr cdr car car))\n(define cddadr (compose cdr cdr car cdr))\n(define cdddar (compose cdr cdr cdr car))\n(define cddddr (compose cdr cdr cdr cdr))\n\n(define (list? l)\n  ; The interview staple: find a cycle in a linked list.\n  ;\n  ; The main idea is to send one pointer through the list hitting every node,\n  ; and another pointer through the list hitting every second node. If there\n  ; is a cycle of length n, the two pointers will eventually coincide.\n  ;\n  ; Proof: suppose pointers X and Y start at positions x and y\n  ; respectively on the cycle, 0 <= x,y < n. After k moves:\n  ;\n  ; X is at x+k (mod n)\n  ; Y is at y+2k (mod n)\n  ;\n  ; So we just have to show that\n  ;\n  ; x+k = y+2k (mod n)\n  ;\n  ; always has a solution. Sure:\n  ;\n  ; k = x-y (mod n)\n  ;\n  ; so the two pointers coincide after fewer than n steps.\n  (define (detect-cycle x y)\n    (cond ((null? x) (list? y)) ; x finished first, just check y is ok\n\t  ((null? y) (list? x)) ; y finished first, just check x is ok\n\t  ((or (not (pair? x)) (not (pair? y)))\n\t   #f) ; x or y is not a pair: fail\n\t  ((eq? x y) #f) ; cycle: fail\n\t  (else\n\t   (let* ((next-x (cdr x))\n\t\t  (next-y (cdr y)))\n\t     (cond ((null? next-y) (list? next-x)) ; y finished, just check x is ok\n\t\t   ((not (pair? next-y)) #f) ; next-y is not a pair: fail\n\t\t   (else ; advance x by 1 and y by 2\n\t\t    (detect-cycle next-x (cdr next-y))))))))\n  (cond ((null? l) #t) ; various corner cases before input to detect-cycle\n\t((not (pair? l)) #f)\n\t((null? (cdr l))\n\t (if (pair? (car l)) ; not sure about this but seems to be required...\n\t     (detect-cycle (car l) (caar l))\n\t     #t))\n\t((not (pair? (cdr l))) #f)\n\t(else (detect-cycle l (cdr l)))))\n\n(define (list . xs) xs) ; p. 27\n\n(define (foldl f start xs) ; helper function, not in R5RS\n  (if (null? xs)\n      start\n      (foldl f (f start (car xs)) (cdr xs))))\n\n(define (length xs) ; p. 27\n  (foldl\n   (lambda (x y) (+ x 1))\n   0\n   xs))\n\n(define (append . xs) ; p. 27\n  (define (append2 xs ys)\n    (if (null? xs)\n\tys\n\t(cons (car xs) (append2 (cdr xs) ys))))\n  (foldl append2 '() xs))\n\n(define (flip f) (lambda (x y) (f y x))) ; helper function, not in R5RS\n\n(define (reverse xs) (foldl (flip cons) '() xs)) ; p. 27\n\n(define (list-tail xs k) ; p. 27\n  (if (= k 0)\n      xs\n      (list-tail (cdr xs) (- k 1))))\n\n(define (list-ref xs k) (car (list-tail xs k))) ; p. 27\n\n(define (member-abstract are-equal?) ; helper function, not in R5RS\n  (lambda (x ys)\n    (if (null? ys)\n\t#f\n\t(if (are-equal? x (car ys))\n\t    ys\n\t    ((member-abstract are-equal?) x (cdr ys))))))\n\n(define memq (member-abstract eq?)) ; p. 27\n(define memv (member-abstract eqv?)) ; p. 27\n(define member (member-abstract equal?)) ; p. 27\n\n(define (find xs predicate?) ; helper function, not in R5RS\n  (cond\n   ((null? xs) #f)\n   ((predicate? (car xs)) (car xs))\n   (else (find (cdr xs) predicate?))))\n\n(define (assq obj alist) ; p. 27\n  (find\n   alist\n   (lambda (pair) (eq? (car pair) obj))))\n\n(define (assv obj alist) ; p. 27\n  (find\n   alist\n   (lambda (pair) (eqv? (car pair) obj))))\n\n(define (assoc obj alist) ; p. 27\n  (find\n   alist\n   (lambda (pair) (equal? (car pair) obj))))\n\n; These two are listed as library procedures, but I don't see how\n; to implement them in Scheme without having a big switch on each character,\n; and I'm not going to do that.\n; (define char-upcase [primitive]) ; p. 29\n; (define char-downcase [primitive]) ; p. 29\n\n(define (char-ci-abstract pred?)\n  (lambda (c1 c2)\n    (pred? (char-downcase c1)\n\t   (char-downcase c2))))\n\n(define char-ci=? (char-ci-abstract char=?)) ; p. 29\n(define char-ci<? (char-ci-abstract char<?)) ; p. 29\n(define char-ci>? (char-ci-abstract char>?)) ; p. 29\n(define char-ci<=? (char-ci-abstract char<=?)) ; p. 29\n(define char-ci>=? (char-ci-abstract char>=?)) ; p. 29\n\n(define (string . cs) ; p. 30\n  (let ((new-string (make-string (length cs))))\n    (foldl\n     (lambda (l r) (string-set! new-string l r) (+ l 1))\n     0\n     cs)\n    new-string))\n\n(define (lexicographic true-if goto-next-if compare-lengths-at-end) ; helper function, not in R5RS\n  (lambda (str1 str2)\n    (let* ((len1 (string-length str1))\n\t   (len2 (string-length str2))\n\t   (len (min len1 len2)))\n      (define (lexico-tail i)\n\t(if (= i len)\n\t    (compare-lengths-at-end len1 len2)\n\t    (let* ((yes\n\t\t    (true-if (string-ref str1 i)\n\t\t\t     (string-ref str2 i)))\n\t\t   (maybe\n\t\t    (goto-next-if (string-ref str1 i)\n\t\t\t\t  (string-ref str2 i))))\n\t      (cond\n\t       (yes #t)\n\t       (maybe (lexico-tail (+ i 1)))\n\t       (else #f)))))\n      (lexico-tail 0))))\n\n(define string=?     (lexicographic (lambda (x y) #f) char=? =)) ; p. 30\n(define string-ci=?  (lexicographic (lambda (x y) #f) char-ci=? =))\n(define string<?     (lexicographic char<? char=? <))\n(define string>?     (lexicographic char>? char=? >))\n(define string<=?    (lexicographic char<? char=? <=))\n(define string>=?    (lexicographic char>? char=? >=))\n(define string-ci<?  (lexicographic char-ci<? char-ci=? <))\n(define string-ci>?  (lexicographic char-ci>? char-ci=? >))\n(define string-ci<=? (lexicographic char-ci<? char-ci=? <=))\n(define string-ci>=? (lexicographic char-ci>? char-ci=? >=))\n\n(define (substring str start end) ; p. 30\n  (letrec ((new-str (make-string (- end start)))\n\t (substr-tail\n\t  (lambda (i)\n\t    (string-set! new-str (- i start) (string-ref str i))\n\t    (if (= i start)\n\t\tnew-str\n\t\t(substr-tail (- i 1))))))\n    (if (= start end)\n\tnew-str\n\t(substr-tail (- end 1)))))\n\n(define (string-append . strs) ; p. 30\n  (define (string-append2 str1 str2)\n    (let* ((len1 (string-length str1))\n\t   (len2 (string-length str2))\n\t   (new-str (make-string (+ len1 len2))))\n      (do\n\t  ((i 0 (+ i 1)))\n\t  ((= i len1) new-str)\n\t(string-set! new-str i (string-ref str1 i)))\n      (do\n\t  ((i 0 (+ i 1)))\n\t  ((= i len2) new-str)\n\t(string-set! new-str (+ len1 i) (string-ref str2 i)))))\n  (foldl string-append2 \"\" strs))\n\n(define (string->list str) ; p. 30\n  (let ((new-list '())\n\t(len (string-length str)))\n    (do\n\t((i 0 (+ i 1)))\n\t((= i len) new-list)\n      (set! new-list\n\t    (cons (string-ref str (- len i 1))\n\t\t  new-list)))))\n\n(define (list->string cs) ; p. 30\n  (let ((new-str\n\t (make-string (length cs))))\n  (foldl\n   (lambda (l r)\n     (string-set! new-str l r)\n     (+ l 1))\n   0\n   cs)\n  new-str))\n\n(define (string-copy str) ; p. 30\n  (let* ((len (string-length str))\n\t (new-str (make-string len)))\n    (do\n\t((i 0 (+ i 1)))\n\t((= i len) new-str)\n      (string-set! new-str i (string-ref str i)))))\n\n(define (string-fill! str c) ; p. 31\n  (do\n      ((i 0 (+ i 1)))\n      ((= i (string-length str)) (if #f #f)) ; unspecified value\n    (string-set! str i c)))\n\n(define (list->vector xs) ; p. 31\n  (let ((v (make-vector (length xs))))\n    (foldl\n     (lambda (l r)\n       (vector-set! v l r)\n       (+ l 1))\n     0\n     xs)\n    v))\n\n(define (vector . xs) (list->vector xs)) ; p. 31\n\n(define (vector->list v) ; p. 31\n  (let* ((new-list '())\n\t (len (vector-length v)))\n    (do\n\t((i 0 (+ i 1)))\n\t((= i len) new-list)\n      (set! new-list\n\t    (cons (vector-ref v (- len i 1))\n\t\t  new-list)))))\n\n(define (vector-fill! v f) ; p. 31\n  (do\n      ((i 0 (+ i 1)))\n      ((= i (vector-length v)) (if #f #f)) ; unspecified value\n    (vector-set! v i f)))\n\n(define (transpose list-of-lists) ; helper proc, not in R5RS\n  (cond\n   ((null? list-of-lists) '())\n   ((null? (car list-of-lists)) '())\n   (else\n    (let* ((firsts (map car list-of-lists))\n\t   (rests  (map cdr list-of-lists)))\n      (cons firsts (transpose rests))))))\n\n(define (map f l . ls) ; p. 32\n  (define (map-common f xs)\n    (foldr\n     (lambda (l r) (cons (f l) r))\n     '()\n     xs))\n  (if (null? ls)\n      (map-common f l)\n      (let ((list-of-lists (cons l ls))\n\t    (f-apply (lambda (list) (apply f list))))\n\t(map-common\n\t f-apply\n\t (transpose list-of-lists)))))\n\n(define (for-each f l . ls) ; p. 32\n  (define (for-each-common f xs)\n    (foldl\n     (lambda (l r) (f r))\n     #f\n     xs)\n    (if #f #f)) ; unspecified return value\n  (if (null? ls)\n      (for-each-common f l)\n      (let ((list-of-lists (cons l ls))\n\t    (f-apply (lambda (list) (apply f list))))\n\t(for-each-common\n\t f-apply\n\t (transpose list-of-lists)))))\n\n(define (force object) (object)) ; verbatim from p. 32\n\n(define make-promise ; verbatim from p. 33\n  (lambda (proc)\n    (let ((result-ready? #f)\n\t  (result #f))\n      (lambda ()\n\t(if result-ready?\n\t    result\n\t    (let ((x (proc)))\n\t      (if result-ready?\n\t\t  result\n\t\t  (begin (set! result-ready? #t)\n\t\t\t (set! result x)\n\t\t\t result))))))))\n\n(define (call-with-input-file string proc) ; p. 35\n  (let* ((input (open-input-file string))\n\t (result (proc input)))\n    (close-input-port input)\n    result))\n\n(define (call-with-output-file string proc) ; p. 35\n  (let* ((output (open-output-file string))\n\t (result (proc output)))\n    (close-output-port output)\n    result))\n\n(define (file->string filename) ; not in R5RS, thought it was useful\n  (define (port->string port chars)\n    (let ((maybe (read-char port)))\n      (if (eof-object? maybe)\n\t  (list->string (reverse chars))\n\t  (port->string port (cons maybe chars)))))\n  (let* ((input (open-input-file filename))\n\t (result (port->string input '())))\n    (close-input-port input)\n    result))\n\n(define (newline . maybe-port) ; p. 37\n  (if (null? maybe-port)\n      (write-char #\\newline)\n      (write-char #\\newline (car maybe-port))))\n\n(define oo===D ; Turing's normal-order Y combinator (not in R5RS)\n  (lambda (g)\n    (g (delay (oo===D g)))))\n"},mr=function(t,e,n,r){return new(n||(n=Promise))(function(i,o){function s(t){try{u(r.next(t))}catch(t){o(t)}}function a(t){try{u(r.throw(t))}catch(t){o(t)}}function u(t){t.done?i(t.value):new n(function(e){e(t.value)}).then(s,a)}u((r=r.apply(t,e||[])).next())})},yr="\r".charCodeAt(0),vr="\b".charCodeAt(0),br=function(){function t(t){var e=t.textArea,n=t.interpreter,r=t.inputCompleteHandler,i=t.prompt,o=t.numColumns,s=t.charLatency,a=t.lineLatency,u=this;this.lineStart=0,this.lineEnd=0,this.lineBuf="",this.charHtoW=0,this.textArea=e,this.interpreter=n,this.numColumns=o,this.lineLatency=a,this.prompt=i,this.inputCompleteHandler=r,this.charLatency=s,this.recordCharWidth(),this.resize(),e.addEventListener("keydown",function(t){return u.onKeyDown(t)},!1),addEventListener("resize",function(){return u.resize()},!1)}return t.prototype.onKeyDown=function(t){return mr(this,void 0,void 0,function(){var e,n;return __generator(this,function(r){switch(r.label){case 0:return this.shouldSuppress(t)?(t.preventDefault(),[3,3]):[3,1];case 1:return this.shouldEndLine(t)?(t.preventDefault(),e=this.getCurLine(),n=this.maybeInterpret(e),[4,this.print("\n"+(n||"")+"\n\n"+this.prompt)]):[3,3];case 2:r.sent(),this.lineStart=this.lineEnd=this.textArea.selectionEnd=this.textArea.value.length,r.label=3;case 3:return[2]}})})},t.prototype.shouldSuppress=function(t){var e=this.textArea.selectionEnd;return this.textArea.selectionStart<e&&this.textArea.selectionStart<this.lineStart||(e<this.lineStart?function n(t){return!(t.altKey||t.metaKey||t.ctrlKey||function e(t){switch(t){case 16:case 17:case 18:case 19:case 20:case 27:case 33:case 34:case 35:case 36:case 37:case 38:case 39:case 40:case 45:case 112:case 113:case 114:case 115:case 116:case 117:case 118:case 119:case 120:case 121:case 122:case 123:case 124:case 125:case 126:case 127:case 128:case 129:case 130:case 131:case 132:case 133:case 134:case 135:return!0;default:return!1}}(t.keyCode))}(t):e===this.lineStart&&t.keyCode===vr)},t.prototype.println=function(t){return mr(this,void 0,void 0,function(){var e,n;return __generator(this,function(r){switch(r.label){case 0:if(!(t instanceof Array))return[3,7];e=0,n=t,r.label=1;case 1:return e<n.length?[4,this.println(n[e])]:[3,6];case 2:return r.sent(),[4,this.println("")];case 3:return r.sent(),[4,this.pause(this.lineLatency)];case 4:r.sent(),r.label=5;case 5:return e++,[3,1];case 6:return[3,9];case 7:return[4,this.print("\n"+t)];case 8:r.sent(),r.label=9;case 9:return[2,this]}})})},t.prototype.pause=function(t){return mr(this,void 0,void 0,function(){var e,n;return __generator(this,function(r){switch(r.label){case 0:e=Math.floor(Math.abs(t/this.charLatency)),n=0,r.label=1;case 1:return n<e?[4,this.delay()]:[3,4];case 2:r.sent(),r.label=3;case 3:return++n,[3,1];case 4:return[2]}})})},t.prototype.delay=function(){return mr(this,void 0,void 0,function(){var t=this;return __generator(this,function(e){return[2,new Promise(function(e){return setTimeout(e,t.charLatency)})]})})},t.prototype.print=function(t){return mr(this,void 0,void 0,function(){var e,n,r;return __generator(this,function(i){switch(i.label){case 0:e=new wr(t),n=0,r=t,i.label=1;case 1:return n<r.length?[4,this.delay()]:[3,4];case 2:i.sent(),this.textArea.value+=e.next(),this.textArea.scrollTop=this.textArea.scrollHeight,i.label=3;case 3:return n++,[3,1];case 4:return[4,this.delay()];case 5:return i.sent(),this.textArea.selectionEnd=this.textArea.value.length,[2]}})})},t.prototype.shouldEndLine=function(t){var e=this.textArea.selectionEnd;return!(e<this.lineStart)&&(this.lineEnd=e,t.keyCode===yr)},t.prototype.getCurLine=function(){return this.textArea.value.substr(this.lineStart,this.lineEnd-this.lineStart+1)},t.prototype.maybeInterpret=function(t){if(this.lineBuf=this.lineBuf?this.lineBuf+"\n"+t:t,this.inputCompleteHandler&&!this.inputCompleteHandler(this.lineBuf))return"...";var e=this.lineBuf;this.lineBuf=null;try{var n=this.interpreter(e,this);if(n)return n}catch(t){return t.toString()}},t.prototype.start=function(){return mr(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.println(this.prompt)];case 1:return t.sent(),this.lineStart=this.textArea.selectionStart=this.textArea.selectionEnd=this.textArea.value.length,this.lineEnd=this.lineStart+1,this.lineBuf=null,[2]}})})},t.prototype.reset=function(){return mr(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.delay()];case 1:return t.sent(),this.textArea.value="",this.lineStart=this.textArea.selectionStart=this.textArea.selectionEnd=this.textArea.value.length,this.lineEnd=this.lineStart+1,this.lineBuf=null,[2]}})})},t.prototype.recordCharWidth=function(){var t=document.createElement("span");t.style.visibility="hidden",t.appendChild(document.createTextNode("X")),document.body.appendChild(t);var e=t.getBoundingClientRect();this.charHtoW=e.height/e.width},t.prototype.resize=function(){var t=this.textArea.getBoundingClientRect().width;this.textArea.style.fontSize=t/this.numColumns*this.charHtoW+"px"},t}(),wr=function(){function t(t){this.str=t,this.offset=0}return t.prototype.next=function(){return this.str.charAt(this.offset++)},t}();document.addEventListener("DOMContentLoaded",function xr(){return t=this,void 0,i=function(){var t,n,i;return __generator(this,function(o){switch(o.label){case 0:return t=new gr,n=function s(t,n,i,o){void 0===i&&(i=e),void 0===o&&(o=r);var s=new Je(null);pr(t,s),s.seal();var a=s.clone();return ir(s,a),pr(n,a),a.seal(),new fr(new hr(a),i,o)}(t.syntax,t.procedures),[4,(i=new br({textArea:document.getElementsByTagName("textarea")[0],interpreter:function(t,e){return n.evaluate(t)},prompt:">> ",inputCompleteHandler:dr,numColumns:80,charLatency:10,lineLatency:500})).println("\n          ______   _      \n   _____ / ____/  (_)_____\n  / ___//___ \\   / // ___/\n / /   ____/ /  / /(__  ) \n/_/   /_____/__/ //____/  \n            /___/         \n\n;; built at 1cff580 (2019-04-04)\n")];case 1:return o.sent(),[4,i.start()];case 2:return o.sent(),[2]}})},new((n=void 0)||(n=Promise))(function(e,r){function o(t){try{a(i.next(t))}catch(t){r(t)}}function s(t){try{a(i.throw(t))}catch(t){r(t)}}function a(t){t.done?e(t.value):new n(function(e){e(t.value)}).then(o,s)}a((i=i.apply(t,[])).next())});var t,n,i},!1)}();