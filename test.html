<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <title>r5js</title>
    <script type="text/javascript" src="datum.js"></script>
    <script type="text/javascript" src="types.js"></script>
    <script type="text/javascript" src="errors.js"></script>
    <script type="text/javascript" src="scan.js"></script>
    <script type="text/javascript" src="parse.js"></script>
    <script type="text/javascript" src="read.js"></script>
    <script type="text/javascript" src="macro.js"></script>
    <script type="text/javascript" src="eval.js"></script>
    <script type="text/javascript" src="stdproc.js"></script>
    <script type="text/javascript" src="unit_test.js"></script>
    <script type="text/javascript">

        /* We want to load and evaluate the standard library (written in Scheme)
         when the page loads. This is unfortunately trickier than it ought to be.
         It would be nice to be able to say something like
         <script type="text/plain" src="lib.scm"> and have the contents available
         in the DOM, so we can direct the interpreter to read them. But you can't do
         that.

         Some other approaches I decided against:

         - Writing the standard library as a JavaScript file that exported one huge
         string literal: var stdLib = "<lots of Scheme code>". Yuck.

         - Ajax to do a GET request on lib.scm and parse it. It would be nice not to
         have to run an actual web server for an application that should be 100%
         client-side. Ajax is also not a good logical fit since there's not much you can
         do in the interpreter if the standard library didn't load.

         So I decided to stick the standard library in an iframe and reach into it at
         document load time. Unfortunately, this has some cross-origin issues on
         some browsers. My understanding is that browsers implement the same
         origin policy reasonably uniformly in the http:// scheme, but differently in
         the file:// scheme. In particular, Chrome puts each file:// resource in its own
         origin! This means that the standard library will not load in Chrome when
         developing on a local machine, unless we run a server. Firefox and Opera
         appear to use directory-based file:// origins, so it works in them.

         I'm also not sure why the plain text of the Scheme library gets stuck in
         a <pre> wrapper, but most browsers seem to do it. */

        window.addEventListener('load', function() {
            var iframe = document
                    .getElementById('lib')
                    .contentDocument;
            if (iframe) {
                /* todo bl possibly browser-dependent hack: when reaching
                    into the pseudo-iframe defined by the text file, it looks
                    like the pseudo-DOM has replaced occurrences of ">"
                    by "&gt;". This is a problem chiefly for the Scheme token "=>".
                    Reconstruct this here. */
                var stdLib = iframe.getElementsByTagName('pre')[0].innerHTML.replace(/&gt;/g, ">");
                desugar(stdLib, builtins);
                console.log('evaled std lib ok');
            }

        }, false);

        function doScan() {
            console.log(
                    new Scanner(
                            document.getElementById('toEval').value).tokenize());
        }

        function doRead() {
            var ans =
                    new Reader(
                            new Scanner(
                                    document.getElementById('toEval').value)
                    ).read();
            console.log(ans);
            document.getElementById('result').value = ans;
        }

        function doParse() {
            console.log(
                    new Parser(
                            new Reader(
                                    new Scanner(document.getElementById('toEval').value)
                            ).read()
                    ).parse(document.getElementById('lhs').value));
        }

        function doDesugar() {
            var desugared = desugar(document.getElementById('toEval').value, builtins, document.getElementById('lhs').value);
            console.log(desugared);
            document.getElementById('result').value = desugared.toStringWithSiblings();
        }

        function doCPS() {
            var datum = new Reader(new Scanner(document.getElementById('toEval').value)).read();
            var ans = newEmptyList();
            datum.cpsify('root', ans);
            console.log(ans.firstChild);
            document.getElementById('result').value = ans.firstChild;
        }

        function doCPSEval() {
            var desugared =
                    new Parser(
                    new Reader(
                            new Scanner(
                                    document.getElementById('toEval').value)).read()
                            ).parse(document.getElementById('lhs').value)
            .desugar(builtins);
            var ans = trampoline(desugared, builtins);
            console.log(ans);
            document.getElementById('result').value = ans;
        }

        function isCPS() {
            var datum = new Reader(new Scanner(document.getElementById('toEval').value)).read();
            var ans = true;
            for (var cur = datum; cur; cur = cur.nextSibling) {
                if (!cur.cpsSanityCheck()) {
                    ans = false;
                    break;
                }
            }
            console.log(ans);
        }
    </script>

</head>
<body>
<iframe src='lib.scm' id='lib' style='display: none'></iframe>
<textarea id='toEval' rows="15" cols="80"></textarea>
<textarea id='result' rows="1" cols="80"></textarea>
<p>
        <button onclick='isCPS()'>CPS?</button>
    <button onclick='doCPS()'>convert to CPS</button>
    <button onclick='doCPSEval()'>CPS eval</button>
</p>
<p>
    <button onclick='doDesugar()'>desugar</button>
</p>
<p>
    <button onclick="doScan()">scan</button>
    <button onclick="testScanner()">scanner unit tests</button>
</p>
<p>
    <button onclick='doRead()'>read</button>
</p>
<p>
    <button onclick='doParse()'>parse</button>
    <label>as:</label><textarea id='lhs' rows="1" cols="20"></textarea>
    <button onclick="testParser()">parser unit tests</button>
</p>
</body>

</html>
